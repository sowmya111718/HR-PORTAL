<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAKSIM HR System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .login-container, .app-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            width: 100%;
            max-width: 400px;
            transition: all 0.3s ease;
        }

        .app-container {
            max-width: 1400px;
            display: none;
        }

        .app-container.show {
            display: block;
        }

        .login-box {
            padding: 40px;
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo h1 {
            color: #4a5568;
            font-size: 28px;
            margin-bottom: 5px;
        }

        .logo p {
            color: #718096;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .hidden {
            display: none !important;
        }

        /* App Layout */
        .app-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .app-header h1 {
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-label {
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-label.hr {
            background: rgba(72, 187, 120, 0.2);
        }

        .user-label.pm {
            background: rgba(56, 178, 172, 0.2);
        }

        #logoutBtn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: background 0.3s;
        }

        #logoutBtn:hover {
            background: rgba(255,255,255,0.3);
        }

        .app-main {
            display: flex;
            min-height: 800px;
        }

        .sidebar {
            width: 250px;
            background: #f7fafc;
            border-right: 1px solid #e2e8f0;
            padding: 20px 0;
        }

        .sidebar-nav {
            list-style: none;
        }

        .sidebar-nav a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px 25px;
            color: #4a5568;
            text-decoration: none;
            transition: all 0.3s;
            border-left: 4px solid transparent;
        }

        .sidebar-nav a:hover, .sidebar-nav a.active {
            background: #edf2f7;
            color: #667eea;
            border-left-color: #667eea;
        }

        .main-content {
            flex: 1;
            padding: 30px;
            background: #f8fafc;
            overflow-y: auto;
        }

        .page-title {
            color: #2d3748;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
            font-size: 24px;
        }

        /* Dashboard Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .stat-card:nth-child(1) .stat-icon { background: #fed7d7; color: #c53030; }
        .stat-card:nth-child(2) .stat-icon { background: #c6f6d5; color: #276749; }
        .stat-card:nth-child(3) .stat-icon { background: #bee3f8; color: #2c5282; }
        .stat-card:nth-child(4) .stat-icon { background: #e9d8fd; color: #553c9a; }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #718096;
            font-size: 14px;
        }

        /* Tables */
        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .card-title {
            font-size: 20px;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f7fafc;
        }

        th {
            padding: 15px;
            text-align: left;
            color: #4a5568;
            font-weight: 600;
            border-bottom: 2px solid #e2e8f0;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            color: #4a5568;
        }

        tbody tr:hover {
            background: #f7fafc;
        }

        /* Buttons */
        .btn-small {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }

        .btn-approve { background: #c6f6d5; color: #276749; }
        .btn-reject { background: #fed7d7; color: #c53030; }
        .btn-view { background: #bee3f8; color: #2c5282; }
        .btn-edit { background: #e9d8fd; color: #553c9a; }
        .btn-delete { background: #fed7e2; color: #b83280; }
        .btn-cancel { background: #feebc8; color: #c05621; }
        .btn-success { background: #48bb78; color: white; }
        .btn-warning { background: #ed8936; color: white; }

        .btn-small:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* Status Badges */
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .status-pending { background: #feebc8; color: #c05621; }
        .status-approved { background: #c6f6d5; color: #276749; }
        .status-rejected { background: #fed7d7; color: #c53030; }
        .status-cancelled { background: #e2e8f0; color: #4a5568; }

        /* Form Layout */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            color: #2d3748;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #718096;
        }

        /* Toast */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }

        .toast {
            background: white;
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 15px;
            animation: slideIn 0.3s ease;
            min-width: 300px;
        }

        .toast.success { border-left: 4px solid #48bb78; }
        .toast.error { border-left: 4px solid #f56565; }
        .toast.warning { border-left: 4px solid #ed8936; }
        .toast.info { border-left: 4px solid #4299e1; }

        .toast i {
            font-size: 20px;
        }

        .toast.success i { color: #48bb78; }
        .toast.error i { color: #f56565; }
        .toast.warning i { color: #ed8936; }
        .toast.info i { color: #4299e1; }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            color: #2d3748;
        }

        .toast-message {
            color: #718096;
            font-size: 14px;
            margin-top: 2px;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pagination button:hover {
            background: #f7fafc;
            border-color: #cbd5e0;
        }

        .pagination button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* User Role Badges */
        .user-role-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
        }

        .role-hr { background: #c6f6d5; color: #276749; }
        .role-pm { background: #bee3f8; color: #2c5282; }
        .role-manager { background: #e9d8fd; color: #553c9a; }
        .role-employee { background: #fed7e2; color: #b83280; }

        /* Timesheet */
        .timesheet-form {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .timesheet-row {
            display: grid;
            grid-template-columns: 1fr 0.8fr 1.2fr 1fr 1fr 1.2fr 1fr 0.8fr;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e2e8f0;
        }

        .timesheet-field {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .timesheet-field-small {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 100px;
        }

        .time-input {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .time-input input {
            width: 60px;
        }

        .time-separator {
            font-weight: bold;
            color: #718096;
        }

        .no-timesheet {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .no-timesheet i {
            font-size: 48px;
            margin-bottom: 15px;
            color: #cbd5e0;
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div class="login-container" id="loginPage">
        <div class="login-box">
            <div class="logo">
                <h1><i class="fas fa-users"></i> MAKSIM HR</h1>
                <p>Human Resource Management System</p>
            </div>
            <div class="form-group">
                <label class="form-label">Username</label>
                <input type="text" id="username" class="form-control" placeholder="Enter username">
            </div>
            <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" id="password" class="form-control" placeholder="Enter password">
            </div>
            <button class="btn" onclick="login()">Login</button>
        </div>
    </div>

    <!-- Main Application -->
    <div class="app-container hidden" id="app">
        <!-- Header -->
        <div class="app-header">
            <h1><i class="fas fa-users"></i> MAKSIM HR System</h1>
            <div class="user-info">
                <div class="user-label" id="userLabel">
                    <i class="fas fa-user"></i> <span id="usernameDisplay"></span>
                </div>
                <button id="logoutBtn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>

        <!-- Main Layout -->
        <div class="app-main">
            <!-- Sidebar -->
            <div class="sidebar">
                <ul class="sidebar-nav">
                    <li><a href="javascript:void(0)" onclick="showPage('dashboard')" class="active">
                        <i class="fas fa-home"></i> Dashboard
                    </a></li>
                    <li><a href="javascript:void(0)" onclick="showPage('leaves')">
                        <i class="fas fa-umbrella-beach"></i> Leave Management
                    </a></li>
                    <li><a href="javascript:void(0)" onclick="showPage('permissions')">
                        <i class="fas fa-clock"></i> Permission Management
                    </a></li>
                    <li><a href="javascript:void(0)" onclick="showPage('timesheet')">
                        <i class="fas fa-calendar-alt"></i> Timesheet
                    </a></li>
                    <li><a href="javascript:void(0)" onclick="showPage('attendanceReport')">
                        <i class="fas fa-calendar-check"></i> Attendance Report
                    </a></li>
                    <li id="hrLink" class="hidden"><a href="javascript:void(0)" onclick="showPage('hrPanel')">
                        <i class="fas fa-user-tie"></i> HR Panel
                    </a></li>
                    <li id="userManagementLink" class="hidden"><a href="javascript:void(0)" onclick="showPage('userManagement')">
                        <i class="fas fa-user-cog"></i> User Management
                    </a></li>
                    <li id="adminLink" class="hidden"><a href="javascript:void(0)" onclick="showPage('adminSettings')">
                        <i class="fas fa-cog"></i> System Administration
                    </a></li>
                    <li><a href="javascript:void(0)" onclick="showPage('changePassword')">
                        <i class="fas fa-key"></i> Change Password
                    </a></li>
                </ul>
            </div>

            <!-- Main Content -->
            <div class="main-content">
                <h2 class="page-title" id="pageTitle">Dashboard</h2>
                
                <!-- Dashboard -->
                <div id="dashboard">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-heartbeat"></i></div>
                            <div class="stat-value" id="sickLeaveBalance">6</div>
                            <div class="stat-label">Sick Leave Balance</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-coffee"></i></div>
                            <div class="stat-value" id="casualLeaveBalance">12</div>
                            <div class="stat-label">Casual Leave Balance</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-plane"></i></div>
                            <div class="stat-value" id="otherLeaveBalance">40</div>
                            <div class="stat-label">Other Leave Balance</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-hourglass-half"></i></div>
                            <div class="stat-value" id="pendingRequests">0</div>
                            <div class="stat-label">Pending Requests</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-balance-scale"></i> Leave Balance</h3>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Leave Type</th>
                                        <th>Total Days</th>
                                        <th>Used Days</th>
                                        <th>Remaining Days</th>
                                        <th>Usage</th>
                                    </tr>
                                </thead>
                                <tbody id="leaveBalanceTable">
                                    <!-- Leave balance rows will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Leave Management -->
                <div id="leaves" class="hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-plus-circle"></i> Apply for Leave</h3>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">From Date</label>
                                <input type="date" id="fromDate" class="form-control">
                            </div>
                            <div class="form-group">
                                <label class="form-label">To Date</label>
                                <input type="date" id="toDate" class="form-control">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Leave Type</label>
                                <select id="leaveType" class="form-control">
                                    <option value="">Select Type</option>
                                    <option value="Sick">Sick Leave</option>
                                    <option value="Casual">Casual Leave</option>
                                    <option value="Other">Other Leave</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Day Type</label>
                                <div style="display: flex; gap: 20px; margin-top: 8px;">
                                    <label style="display: flex; align-items: center; gap: 5px;">
                                        <input type="radio" name="leaveDayType" value="full" checked> Full Day
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 5px;">
                                        <input type="radio" name="leaveDayType" value="half"> Half Day
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Reason</label>
                            <textarea id="leaveReason" class="form-control" rows="3" placeholder="Enter reason for leave"></textarea>
                        </div>
                        <button class="btn" onclick="applyLeave()">Apply Leave</button>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-list"></i> My Leave Applications</h3>
                        </div>
                        <div class="table-container">
                            <table id="empLeaveTable">
                                <thead>
                                    <tr>
                                        <th>Type</th>
                                        <th>From</th>
                                        <th>To</th>
                                        <th>Days</th>
                                        <th>Status</th>
                                        <th>Reason</th>
                                        <th>Day Type</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Leave applications will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Permission Management -->
                <div id="permissions" class="hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-plus-circle"></i> Apply for Permission</h3>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Date</label>
                                <input type="date" id="permDate" class="form-control">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Duration (hours)</label>
                                <select id="permHours" class="form-control">
                                    <option value="1">1 hour</option>
                                    <option value="2">2 hours</option>
                                    <option value="3">3 hours</option>
                                    <option value="4">4 hours</option>
                                    <option value="8">Full Day (8 hours)</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Reason</label>
                            <textarea id="permReason" class="form-control" rows="3" placeholder="Enter reason for permission"></textarea>
                        </div>
                        <button class="btn" onclick="applyPermission()">Apply Permission</button>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-list"></i> My Permission Requests</h3>
                        </div>
                        <div class="table-container">
                            <table id="empPermTable">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Duration</th>
                                        <th>Status</th>
                                        <th>Reason</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Permission requests will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Timesheet -->
                <div id="timesheet" class="hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-clock"></i> Today's Timesheet - <span id="timesheetTodayDate"></span></h3>
                            <div id="hrUserSelectContainer" class="hidden">
                                <select id="timesheetUserSelect" class="form-control" style="width: 200px;">
                                    <!-- Users will be populated here -->
                                </select>
                            </div>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <div style="display: flex; gap: 20px; margin-bottom: 10px;">
                                <div>
                                    <strong>Employee:</strong> <span id="timesheetCurrentUser"></span>
                                </div>
                                <div>
                                    <strong>Reporting To:</strong> <span id="timesheetReportingTo"></span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="timesheet-form">
                            <h4 style="margin-bottom: 20px; color: #4a5568;">Add Timesheet Entry</h4>
                            <div id="timesheetForm">
                                <!-- Timesheet rows will be added here -->
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button class="btn btn-success" onclick="addTimesheetRow()">
                                    <i class="fas fa-plus"></i> Add Row
                                </button>
                                <button class="btn" onclick="submitTimesheet()">
                                    <i class="fas fa-paper-plane"></i> Submit Timesheet
                                </button>
                            </div>
                        </div>

                        <div id="timesheetTotal" class="hidden" style="background: #c6f6d5; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>Total Hours Today:</strong>
                            </div>
                            <div style="font-size: 24px; font-weight: bold; color: #276749;">
                                <span id="totalHours">0.00</span> hrs
                            </div>
                        </div>

                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Hours</th>
                                        <th>Project</th>
                                        <th>Module</th>
                                        <th>Sub Module</th>
                                        <th>Task</th>
                                        <th>Remarks</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="timesheetTableBody">
                                    <!-- Timesheet entries will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- HR Panel -->
                <div id="hrPanel" class="hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-umbrella-beach"></i> Leave Requests Management</h3>
                            <div style="display: flex; gap: 10px;">
                                <select id="leaveFilter" class="form-control" style="width: 150px;" onchange="filterLeaves()">
                                    <option value="all">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="approved">Approved</option>
                                    <option value="rejected">Rejected</option>
                                </select>
                                <button class="btn btn-success" onclick="exportLeavesExcel()">
                                    <i class="fas fa-file-excel"></i> Export Excel
                                </button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table id="hrLeaveTable">
                                <thead>
                                    <tr>
                                        <th>Employee</th>
                                        <th>Type</th>
                                        <th>From</th>
                                        <th>To</th>
                                        <th>Days</th>
                                        <th>Status</th>
                                        <th>Reason</th>
                                        <th>Day Type</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- HR leave requests will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                        <div id="leavePagination" class="pagination">
                            <!-- Pagination will be inserted here -->
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-clock"></i> Permission Requests Management</h3>
                            <div style="display: flex; gap: 10px;">
                                <select id="permFilter" class="form-control" style="width: 150px;" onchange="filterPermissions()">
                                    <option value="all">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="approved">Approved</option>
                                    <option value="rejected">Rejected</option>
                                </select>
                                <button class="btn btn-success" onclick="exportPermissionsExcel()">
                                    <i class="fas fa-file-excel"></i> Export Excel
                                </button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table id="hrPermTable">
                                <thead>
                                    <tr>
                                        <th>Employee</th>
                                        <th>Date</th>
                                        <th>Duration</th>
                                        <th>Status</th>
                                        <th>Reason</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- HR permission requests will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                        <div id="permPagination" class="pagination">
                            <!-- Pagination will be inserted here -->
                        </div>
                    </div>
                </div>

                <!-- User Management -->
                <div id="userManagement" class="hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-user-cog"></i> User Management</h3>
                            <button class="btn" onclick="openAddUserModal()">
                                <i class="fas fa-plus"></i> Add New User
                            </button>
                        </div>
                        <div class="form-group" style="margin-bottom: 20px;">
                            <input type="text" id="userSearch" class="form-control" placeholder="Search users..." onkeyup="searchUsers()">
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Username</th>
                                        <th>Full Name</th>
                                        <th>Role</th>
                                        <th>Reporting To</th>
                                        <th>Department</th>
                                        <th>Join Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <!-- Users will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- System Administration -->
                <div id="adminSettings" class="hidden">
                    <div class="card">
                        <h3 class="card-title" style="margin-bottom: 20px;"><i class="fas fa-cog"></i> System Administration</h3>
                        
                        <div class="stats-grid" style="margin-bottom: 30px;">
                            <div class="stat-card">
                                <div class="stat-icon"><i class="fas fa-users"></i></div>
                                <div class="stat-value" id="totalUsers">0</div>
                                <div class="stat-label">Total Users</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon"><i class="fas fa-umbrella-beach"></i></div>
                                <div class="stat-value" id="totalLeavesCount">0</div>
                                <div class="stat-label">Leave Requests</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon"><i class="fas fa-clock"></i></div>
                                <div class="stat-value" id="totalPermissions">0</div>
                                <div class="stat-label">Permission Requests</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon"><i class="fas fa-database"></i></div>
                                <div class="stat-value" id="storageUsed">0 KB</div>
                                <div class="stat-label">Storage Used</div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                            <div style="background: white; padding: 20px; border-radius: 10px; border: 1px solid #e2e8f0;">
                                <h4 style="margin-bottom: 15px; color: #4a5568;">Data Management</h4>
                                <div style="display: flex; flex-direction: column; gap: 10px;">
                                    <button class="btn btn-success" onclick="exportAllData()">
                                        <i class="fas fa-download"></i> Export All Data
                                    </button>
                                    <button class="btn btn-warning" onclick="showClearDataConfirm()">
                                        <i class="fas fa-trash"></i> Clear All Data
                                    </button>
                                </div>
                            </div>

                            <div style="background: white; padding: 20px; border-radius: 10px; border: 1px solid #e2e8f0;">
                                <h4 style="margin-bottom: 15px; color: #4a5568;">System Info</h4>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>Timesheets:</span>
                                        <strong id="totalTimesheets">0</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>Attendance Records:</span>
                                        <strong id="totalAttendance">0</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>Last Updated:</span>
                                        <strong id="lastUpdated">Just now</strong>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Clear Data Confirmation -->
                        <div id="clearDataConfirm" class="hidden" style="margin-top: 20px; padding: 20px; background: #fff5f5; border-radius: 10px; border: 1px solid #fed7d7;">
                            <h4 style="color: #c53030; margin-bottom: 10px;"><i class="fas fa-exclamation-triangle"></i> Danger Zone</h4>
                            <p style="margin-bottom: 15px; color: #718096;">
                                This will delete ALL data including users, leaves, permissions, and timesheets. This action cannot be undone!
                            </p>
                            <div style="margin-bottom: 15px;">
                                <label class="form-label">Type "RESET SYSTEM" to confirm:</label>
                                <input type="text" id="clearDataConfirmInput" class="form-control" placeholder="RESET SYSTEM">
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-warning" onclick="clearAllData()">Confirm & Reset System</button>
                                <button class="btn" onclick="hideClearDataConfirm()">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Change Password -->
                <div id="changePassword" class="hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-key"></i> Change Password</h3>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Current Password</label>
                            <input type="password" id="oldPass" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">New Password</label>
                            <input type="password" id="newPass" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Confirm New Password</label>
                            <input type="password" id="confirmNewPass" class="form-control">
                        </div>
                        <button class="btn" onclick="changePassword()">Change Password</button>
                    </div>
                </div>

                <!-- Attendance Report -->
                <div id="attendanceReport" class="hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-calendar-check"></i> Attendance Report</h3>
                            <div style="display: flex; gap: 10px;">
                                <input type="month" id="reportMonth" class="form-control" style="width: 150px;">
                                <button class="btn" onclick="generateReport()">
                                    <i class="fas fa-chart-bar"></i> Generate Report
                                </button>
                            </div>
                        </div>
                        <div id="hrUploadSection" class="hidden" style="margin-bottom: 20px; padding: 20px; background: #f7fafc; border-radius: 10px;">
                            <h4 style="margin-bottom: 15px; color: #4a5568;">Upload Attendance File</h4>
                            <div style="display: flex; gap: 10px;">
                                <input type="file" id="attendanceFile" class="form-control" accept=".xlsx,.xls,.csv" style="flex: 1;">
                                <button class="btn btn-success">
                                    <i class="fas fa-upload"></i> Upload
                                </button>
                            </div>
                            <div id="uploadedFilesList" style="margin-top: 15px;">
                                <!-- Uploaded files will be listed here -->
                            </div>
                        </div>
                        <div class="table-container">
                            <table id="attendanceTable">
                                <thead>
                                    <tr>
                                        <th>Employee</th>
                                        <!-- Dates will be generated dynamically -->
                                    </tr>
                                </thead>
                                <tbody id="attendanceTableBody">
                                    <!-- Attendance data will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Modals -->
    <!-- Leave Details Modal -->
    <div id="leaveDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Leave Details</h3>
                <button class="close-modal" onclick="closeModal('leaveDetailsModal')">&times;</button>
            </div>
            <div id="leaveDetailsContent">
                <!-- Leave details will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Permission Details Modal -->
    <div id="permissionDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Permission Details</h3>
                <button class="close-modal" onclick="closeModal('permissionDetailsModal')">&times;</button>
            </div>
            <div id="permissionDetailsContent">
                <!-- Permission details will be inserted here -->
            </div>
        </div>
    </div>

    <!-- User Management Modal -->
    <div id="userManagementModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="userModalTitle">Add New User</h3>
                <button class="close-modal" onclick="closeModal('userManagementModal')">&times;</button>
            </div>
            <div style="display: grid; gap: 15px;">
                <div class="form-group">
                    <label class="form-label">Username *</label>
                    <input type="text" id="modalUsername" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">Full Name *</label>
                    <input type="text" id="modalFullName" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">Password *</label>
                    <input type="password" id="modalPassword" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">Role *</label>
                    <select id="modalRole" class="form-control">
                        <option value="employee">Employee</option>
                        <option value="manager">Manager</option>
                        <option value="hr">HR Manager</option>
                        <option value="pm">Project Manager</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Reporting To *</label>
                    <select id="modalReportingTo" class="form-control"></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="modalEmail" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">Department</label>
                    <input type="text" id="modalDepartment" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">Position</label>
                    <input type="text" id="modalPosition" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">Join Date</label>
                    <input type="date" id="modalJoinDate" class="form-control">
                </div>
                <button class="btn" onclick="saveUser()">Save User</button>
            </div>
        </div>
    </div>

    <!-- Include SheetJS library for Excel generation -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <script>
        // ==============================
        // CONFIGURATION
        // ==============================
        // CHANGE THIS: Set USE_API to false to use fetch() calls
        const USE_API = false; // Set to false to use fetch() calls

        // ==============================
        // DATA INITIALIZATION
        // ==============================
        const leaveLimits = { 
            Sick: 6, 
            Casual: 12,
            Other: 40
        };

        // Default users (for initial setup only) - ADDED PROJECT MANAGER
        const defaultUsers = { 
            hr: { 
                password: "hr123", 
                role: "hr", 
                name: "HR Manager", 
                reportingTo: "CEO",
                email: "hr@maksim.com",
                department: "HR",
                position: "HR Manager",
                joinDate: "2024-01-01"
            },
            admin: { 
                password: "admin123", 
                role: "admin", 
                name: "Administrator", 
                reportingTo: "HR Manager",
                email: "admin@maksim.com",
                department: "IT",
                position: "System Administrator",
                joinDate: "2024-01-01"
            },
            employee: { 
                password: "emp123", 
                role: "employee", 
                name: "chiru", 
                reportingTo: "manager",
                email: "chiru@maksim.com",
                department: "Operations",
                position: "Executive",
                joinDate: "2024-01-01"
            },
            venkatesh: { 
                password: "venkat123", 
                role: "employee", 
                name: "Gadapa Venkateshwar Rao", 
                reportingTo: "Tulasiram Nandanampati",
                email: "venkatesh@maksim.com",
                department: "IT",
                position: "Developer",
                joinDate: "2024-01-01"
            },
            manager: {
                password: "manager123",
                role: "manager",
                name: "Department Manager",
                reportingTo: "HR Manager",
                email: "manager@maksim.com",
                department: "Management",
                position: "Department Manager",
                joinDate: "2024-01-01"
            },
            // NEW PROJECT MANAGER USER WITH ALL PRIVILEGES
            projectmanager: {
                password: "pm123",
                role: "pm",
                name: "Project Manager",
                reportingTo: "CEO",
                email: "pm@maksim.com",
                department: "Project Management",
                position: "Senior Project Manager",
                joinDate: "2024-01-01"
            }
        };

        // Initialize data from localStorage (for fallback when fetch() fails)
        let users = JSON.parse(localStorage.getItem("users")) || defaultUsers;
        let leaves = JSON.parse(localStorage.getItem("leaves")) || [];
        let permissions = JSON.parse(localStorage.getItem("permissions")) || [];
        let timesheetData = JSON.parse(localStorage.getItem("timesheetData")) || [];
        let attendanceData = JSON.parse(localStorage.getItem("attendanceData")) || [];
        let uploadedFiles = JSON.parse(localStorage.getItem("uploadedFiles")) || [];

        let currentUser = "", role = "";
        let currentLeavePage = 1;
        let currentPermPage = 1;
        let currentAttendancePage = 1;
        const itemsPerPage = 20;
        let currentLeaveFilter = 'all';
        let currentPermFilter = 'all';

        // Timesheet row counter
        let timesheetRowCounter = 1;

        // For HR timesheet viewing - track selected user
        let selectedTimesheetUser = null;

        // Variables for user management
        let editingUserId = null;

        // ==============================
        // FETCH HELPER FUNCTIONS
        // ==============================
        async function fetchCall(endpoint, method = 'GET', data = null) {
            const url = `YOUR_BACKEND_URL/${endpoint}`; // Change to your actual backend URL
            
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                }
            };
            
            if (data) {
                options.body = JSON.stringify(data);
            }
            
            try {
                const response = await fetch(url, options);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (!result.success && result.message) {
                    showToast(result.message, 'error');
                }
                
                return result;
            } catch (error) {
                console.error('Fetch Error:', error);
                showToast('Connection error. Please check if server is running.', 'error');
                
                // Fallback to localStorage
                return { success: false, message: 'Using local storage as fallback' };
            }
        }

        // ==============================
        // COMMON FUNCTIONS
        // ==============================

        // Modal Functions
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            if (modalId === 'userManagementModal') {
                resetUserModal();
            }
        }

        // Toast Notification System
        function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info-circle'
            };
            
            toast.innerHTML = `
                <i class="${icons[type]}"></i>
                <div class="toast-content">
                    <div class="toast-title">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
                    <div class="toast-message">${message}</div>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        // Navigation
        function showPage(page) {
            // Update active link
            document.querySelectorAll('.sidebar-nav a').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('onclick') && link.getAttribute('onclick').includes(`showPage('${page}')`)) {
                    link.classList.add('active');
                }
            });
            
            // Hide all pages
            document.querySelectorAll('.main-content > div').forEach(div => {
                if (div.id !== 'toastContainer') {
                    div.classList.add('hidden');
                }
            });
            
            // Show selected page
            const pageElement = document.getElementById(page);
            if (pageElement) {
                pageElement.classList.remove('hidden');
            }
            
            // Update page title
            const pageTitles = {
                dashboard: 'Dashboard',
                attendance: 'Attendance',
                attendanceReport: 'Attendance Report',
                leaves: 'Leave Management',
                permissions: 'Permission Management',
                timesheet: 'Timesheet',
                changePassword: 'Change Password',
                hrPanel: 'HR Dashboard',
                userManagement: 'User Management',
                adminSettings: 'System Administration'
            };
            
            document.getElementById('pageTitle').textContent = pageTitles[page] || page;
            
            // Show/Hide HR/Admin links based on role
            const hrLink = document.getElementById('hrLink');
            const userManagementLink = document.getElementById('userManagementLink');
            const adminLink = document.getElementById('adminLink');
            
            if (role === "hr" || role === "admin" || role === "pm") {
                hrLink?.classList.remove('hidden');
                userManagementLink?.classList.remove('hidden');
                adminLink?.classList.remove('hidden');
            } else {
                hrLink?.classList.add('hidden');
                userManagementLink?.classList.add('hidden');
                adminLink?.classList.add('hidden');
            }
            
            // Load page-specific data
            switch(page) {
                case 'dashboard':
                    updateDashboardStats();
                    break;
                case 'hrPanel':
                    currentLeavePage = 1;
                    currentPermPage = 1;
                    loadHR();
                    break;
                case 'leaves':
                    loadEmpLeaves();
                    break;
                case 'permissions':
                    loadPermissions();
                    break;
                case 'timesheet':
                    updateTimesheetUserDisplay();
                    loadTimesheetData();
                    break;
                case 'userManagement':
                    loadUsers();
                    break;
                case 'adminSettings':
                    refreshSystemInfo();
                    break;
                case 'attendanceReport':
                    const hrUploadSection = document.getElementById('hrUploadSection');
                    if (role === "hr" || role === "admin" || role === "pm") {
                        hrUploadSection?.classList.remove('hidden');
                        loadUploadedFiles();
                    } else {
                        hrUploadSection?.classList.add('hidden');
                    }
                    loadAttendanceReport();
                    break;
            }
        }

        // ==============================
        // AUTHENTICATION FUNCTIONS
        // ==============================
        function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                showToast('Please enter username and password', 'warning');
                return;
            }
            
            if (USE_API) {
                // If USE_API is true, call your backend
                apiLogin(username, password);
            } else {
                // Use localStorage for authentication (fallback)
                localStorageLogin(username, password);
            }
        }

        async function apiLogin(username, password) {
            // This would call your backend API
            const result = await fetchCall('login.php', 'POST', { username, password });
            
            if (result && result.success) {
                handleLoginSuccess(username, result.user.role, result.user);
            }
        }

        function localStorageLogin(username, password) {
            if (users[username] && users[username].password === password) {
                handleLoginSuccess(username, users[username].role, users[username]);
            } else {
                showToast('Invalid username or password', 'error');
            }
        }

        function handleLoginSuccess(username, userRole, userData) {
            currentUser = username;
            role = userRole;
            
            document.getElementById('loginPage').style.opacity = '0';
            document.getElementById('loginPage').style.transition = 'opacity 0.3s';
            
            setTimeout(() => {
                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                
                document.getElementById('usernameDisplay').textContent = userData.name || currentUser;
                document.getElementById('userLabel').innerHTML = 
                    `<i class="fas fa-user"></i> ${userData.name || currentUser}`;
                
                const hrLink = document.getElementById('hrLink');
                const userManagementLink = document.getElementById('userManagementLink');
                const adminLink = document.getElementById('adminLink');
                
                // Set appropriate label styling based on role
                if (role === "hr" || role === "admin" || role === "pm") {
                    hrLink?.classList.remove('hidden');
                    userManagementLink?.classList.remove('hidden');
                    adminLink?.classList.remove('hidden');
                    
                    if (role === "hr") {
                        document.getElementById('userLabel').classList.add('hr');
                    } else if (role === "pm") {
                        document.getElementById('userLabel').classList.add('pm');
                    }
                    
                    showToast(`${role === 'pm' ? 'Project Manager' : 'HR'} Panel access granted`, 'info');
                } else {
                    hrLink?.classList.add('hidden');
                    userManagementLink?.classList.add('hidden');
                    adminLink?.classList.add('hidden');
                    document.getElementById('userLabel').classList.remove('hr', 'pm');
                    showToast('Logged in successfully', 'success');
                }
                
                initializeApp();
                showToast(`Welcome back, ${userData.name || currentUser}!`, 'success');
            }, 300);
        }

        function logout() {
            showToast('Logged out successfully', 'info');
            setTimeout(() => {
                currentUser = "";
                role = "";
                selectedTimesheetUser = null;
                document.getElementById('app').classList.add('hidden');
                document.getElementById('loginPage').classList.remove('hidden');
                document.getElementById('loginPage').style.opacity = '1';
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                const userLabel = document.getElementById('userLabel');
                userLabel?.classList.remove('hr', 'pm');
                
                // Reset all form fields
                resetLeaveForm();
                resetPermissionForm();
                initializeTimesheetForm();
            }, 1000);
        }

        // ==============================
        // INITIALIZATION FUNCTIONS
        // ==============================
        function initializeApp() {
            const today = new Date().toISOString().split('T')[0];
            
            // Set default dates
            const dateElements = [
                {id: 'fromDate', value: today},
                {id: 'toDate', value: today},
                {id: 'permDate', value: today},
                {id: 'attendanceDate', value: today},
                {id: 'modalJoinDate', value: today}
            ];
            
            dateElements.forEach(item => {
                const element = document.getElementById(item.id);
                if (element) {
                    element.value = item.value;
                    element.min = '2024-01-01';
                    element.max = today;
                }
            });
            
            // Set timesheet today date
            const timesheetToday = document.getElementById('timesheetTodayDate');
            if (timesheetToday) {
                timesheetToday.textContent = today;
            }
            
            // Set report year/month
            const now = new Date();
            const currentYear = now.getFullYear().toString();
            const currentMonth = (now.getMonth() + 1).toString().padStart(2, '0');
            
            const reportYear = document.getElementById('reportYear');
            const reportMonth = document.getElementById('reportMonth');
            
            if (reportYear) reportYear.value = currentYear;
            if (reportMonth) reportMonth.value = currentMonth;
            
            updateTimesheetUserDisplay();
            initializeTimesheetForm();
            loadAll();
            
            const hrLink = document.getElementById('hrLink');
            const userManagementLink = document.getElementById('userManagementLink');
            const adminLink = document.getElementById('adminLink');
            if (role === "hr" || role === "admin" || role === "pm") {
                hrLink?.classList.remove('hidden');
                userManagementLink?.classList.remove('hidden');
                adminLink?.classList.remove('hidden');
            } else {
                hrLink?.classList.add('hidden');
                userManagementLink?.classList.add('hidden');
                adminLink?.classList.add('hidden');
            }
            
            refreshSystemInfo();
        }

        function loadAll() {
            loadEmpLeaves();
            loadPermissions();
            loadLeaveBalance();
            updateDashboardStats();
            loadTimesheetData();
            
            if (role === "hr" || role === "admin" || role === "pm") {
                loadUsers();
            }
        }

        // ==============================
        // USER MANAGEMENT FUNCTIONS
        // ==============================
        async function loadUsers() {
            if (role !== "hr" && role !== "admin" && role !== "pm") return;

            if (USE_API) {
                try {
                    // Call your backend API to get users
                    const response = await fetch('YOUR_BACKEND_URL/get_users.php');
                    const users = await response.json();
                    renderUsersTable(users);
                } catch (error) {
                    console.error("Error fetching users:", error);
                    // Fallback to localStorage
                    const userList = Object.keys(users).map(username => ({
                        username,
                        ...users[username]
                    }));
                    renderUsersTable(userList);
                }
            } else {
                // Use localStorage
                const userList = Object.keys(users).map(username => ({
                    username,
                    ...users[username]
                }));
                renderUsersTable(userList);
            }
        }

        function renderUsersTable(userList) {
            const tableBody = document.getElementById('usersTableBody');
            let html = '';
            
            if (userList.length === 0) {
                html = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px;">
                            <i class="fas fa-users" style="font-size: 48px; color: #cbd5e0; margin-bottom: 15px;"></i>
                            <div style="color: #718096; font-size: 16px;">No users found</div>
                        </td>
                    </tr>
                `;
            } else {
                userList.forEach(user => {
                    let roleBadge = '';
                    switch(user.role) {
                        case 'hr':
                        case 'admin':
                            roleBadge = '<span class="user-role-badge role-hr">HR/Admin</span>';
                            break;
                        case 'pm':
                            roleBadge = '<span class="user-role-badge role-pm">Project Manager</span>';
                            break;
                        case 'manager':
                            roleBadge = '<span class="user-role-badge role-manager">Manager</span>';
                            break;
                        case 'employee':
                            roleBadge = '<span class="user-role-badge role-employee">Employee</span>';
                            break;
                    }
                    
                    const deleteDisabled = user.username === currentUser ? 'disabled' : '';
                    
                    html += `
                        <tr>
                            <td>${user.username}</td>
                            <td>${user.full_name || user.name}</td>
                            <td>${roleBadge}</td>
                            <td>${user.reporting_to || user.reportingTo || '-'}</td>
                            <td>${user.department || '-'}</td>
                            <td>${user.join_date || user.joinDate || '-'}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-small btn-edit" onclick="editUser('${user.username}')">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button class="btn-small btn-delete" onclick="deleteUser('${user.username}')" ${deleteDisabled}>
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
            }
            
            tableBody.innerHTML = html;
        }

        function openAddUserModal() {
            editingUserId = null;
            document.getElementById('userModalTitle').textContent = 'Add New User';
            populateReportingToDropdown();
            document.getElementById('modalJoinDate').value = new Date().toISOString().split('T')[0];
            openModal('userManagementModal');
        }

        function editUser(username) {
            const user = users[username];
            if (!user) {
                showToast('User not found', 'error');
                return;
            }
            
            editingUserId = username;
            document.getElementById('userModalTitle').textContent = 'Edit User';
            
            document.getElementById('modalUsername').value = username;
            document.getElementById('modalUsername').disabled = true;
            document.getElementById('modalFullName').value = user.name || '';
            document.getElementById('modalPassword').value = '';
            document.getElementById('modalPassword').placeholder = 'Leave blank to keep current password';
            document.getElementById('modalRole').value = user.role || 'employee';
            document.getElementById('modalEmail').value = user.email || '';
            document.getElementById('modalDepartment').value = user.department || '';
            document.getElementById('modalPosition').value = user.position || '';
            document.getElementById('modalJoinDate').value = user.joinDate || new Date().toISOString().split('T')[0];
            
            populateReportingToDropdown(username);
            document.getElementById('modalReportingTo').value = user.reportingTo || '';
            
            openModal('userManagementModal');
        }

        function populateReportingToDropdown(excludeUser = null) {
            const dropdown = document.getElementById('modalReportingTo');
            if (!dropdown) return;
            
            dropdown.innerHTML = '';
            
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Select Reporting Manager';
            dropdown.appendChild(defaultOption);
            
            Object.keys(users).forEach(username => {
                if (username === excludeUser) return;
                
                const user = users[username];
                if (user.role === 'hr' || user.role === 'manager' || user.role === 'pm') {
                    const option = document.createElement('option');
                    option.value = username;
                    let roleLabel = '';
                    if (user.role === 'hr') roleLabel = 'HR Manager';
                    else if (user.role === 'pm') roleLabel = 'Project Manager';
                    else roleLabel = 'Manager';
                    option.textContent = `${user.name} (${roleLabel})`;
                    dropdown.appendChild(option);
                }
            });
        }

        async function saveUser() {
            const username = document.getElementById('modalUsername').value.trim();
            const fullName = document.getElementById('modalFullName').value.trim();
            const password = document.getElementById('modalPassword').value;
            const role = document.getElementById('modalRole').value;
            const reportingTo = document.getElementById('modalReportingTo').value;
            const email = document.getElementById('modalEmail').value.trim();
            const department = document.getElementById('modalDepartment').value.trim();
            const position = document.getElementById('modalPosition').value.trim();
            const joinDate = document.getElementById('modalJoinDate').value;
            
            if (!username || !fullName || !role || !reportingTo) {
                showToast('Please fill all required fields', 'warning');
                return;
            }
            
            if (!editingUserId && users[username]) {
                showToast('Username already exists', 'error');
                return;
            }
            
            if (USE_API) {
                const userData = {
                    username,
                    full_name: fullName,
                    role,
                    reporting_to: reportingTo,
                    email,
                    department,
                    position,
                    join_date: joinDate
                };
                
                if (password) {
                    userData.password = password;
                }
                
                const endpoint = editingUserId ? 'update_user.php' : 'add_user.php';
                const result = await fetchCall(endpoint, 'POST', userData);
                
                if (result && result.success) {
                    showToast(editingUserId ? 'User updated successfully' : 'User created successfully', 'success');
                    closeModal('userManagementModal');
                    loadUsers();
                }
            } else {
                if (editingUserId) {
                    const user = users[editingUserId];
                    user.name = fullName;
                    user.role = role;
                    user.reportingTo = reportingTo;
                    user.email = email;
                    user.department = department;
                    user.position = position;
                    user.joinDate = joinDate;
                    
                    if (password) {
                        user.password = password;
                    }
                    
                    showToast('User updated successfully', 'success');
                } else {
                    users[username] = {
                        password: password,
                        role: role,
                        name: fullName,
                        reportingTo: reportingTo,
                        email: email,
                        department: department,
                        position: position,
                        joinDate: joinDate
                    };
                    
                    showToast('User created successfully', 'success');
                }
                
                localStorage.setItem("users", JSON.stringify(users));
                closeModal('userManagementModal');
                loadUsers();
                refreshSystemInfo();
            }
        }

        async function deleteUser(username) {
            if (username === currentUser) {
                showToast('You cannot delete your own account', 'error');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete user "${username}"? This action cannot be undone.`)) {
                return;
            }
            
            if (USE_API) {
                const result = await fetchCall('delete_user.php', 'POST', { username });
                if (result && result.success) {
                    showToast('User deleted successfully', 'success');
                    loadUsers();
                }
            } else {
                delete users[username];
                localStorage.setItem("users", JSON.stringify(users));
                showToast('User deleted successfully', 'success');
                loadUsers();
                refreshSystemInfo();
            }
        }

        function resetUserModal() {
            document.getElementById('modalUsername').value = '';
            document.getElementById('modalUsername').disabled = false;
            document.getElementById('modalFullName').value = '';
            document.getElementById('modalPassword').value = '';
            document.getElementById('modalPassword').placeholder = 'Enter password';
            document.getElementById('modalRole').value = 'employee';
            document.getElementById('modalEmail').value = '';
            document.getElementById('modalDepartment').value = '';
            document.getElementById('modalPosition').value = '';
            document.getElementById('modalJoinDate').value = new Date().toISOString().split('T')[0];
            editingUserId = null;
        }

        function searchUsers() {
            const searchTerm = document.getElementById('userSearch').value.toLowerCase();
            const tableRows = document.querySelectorAll('#usersTableBody tr');
            
            tableRows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        // ==============================
        // LEAVE MANAGEMENT FUNCTIONS
        // ==============================
        async function applyLeave() {
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;
            const leaveType = document.getElementById('leaveType').value;
            const reason = document.getElementById('leaveReason').value.trim();
            const dayType = document.querySelector('input[name="leaveDayType"]:checked')?.value || 'full';
            
            if (!fromDate || !toDate || !leaveType || !reason) {
                showToast('Please fill all required fields', 'warning');
                return;
            }
            
            const from = new Date(fromDate);
            const to = new Date(toDate);
            
            if (to < from) {
                showToast('End date cannot be before start date', 'error');
                return;
            }
            
            let days = 0;
            if (fromDate === toDate) {
                days = dayType === 'half' ? 0.5 : 1;
            } else {
                const timeDiff = to.getTime() - from.getTime();
                days = Math.ceil(timeDiff / (1000 * 3600 * 24)) + 1;
            }
            
            if (USE_API) {
                const leaveData = {
                    username: currentUser,
                    leave_type: leaveType,
                    from_date: fromDate,
                    to_date: toDate,
                    days: days,
                    reason: reason,
                    day_type: dayType
                };
                
                const result = await fetchCall('apply_leave.php', 'POST', leaveData);
                
                if (result && result.success) {
                    showToast('Leave application submitted successfully!', 'success');
                    resetLeaveForm();
                    loadEmpLeaves();
                    updateDashboardStats();
                }
            } else {
                leaves = JSON.parse(localStorage.getItem("leaves")) || [];
                
                // Check for overlapping leaves
                let hasExistingApplication = false;
                for (let l of leaves) {
                    if (l.emp === currentUser && l.status !== "Rejected" && l.status !== "Cancelled") {
                        let lFrom = new Date(l.from);
                        let lTo = new Date(l.to);
                        if (!(to < lFrom || from > lTo)) {
                            hasExistingApplication = true;
                            showToast(`You already have a ${l.status.toLowerCase()} leave application for this date range`, 'warning');
                            break;
                        }
                    }
                }
                
                if (hasExistingApplication) return;
                
                // Check leave balance
                if (leaveType !== "Other") {
                    let usedLeaveDays = 0;
                    leaves.forEach(l => {
                        if (l.emp === currentUser && l.type === leaveType && l.status === "Approved") {
                            usedLeaveDays += parseFloat(l.days);
                        }
                    });
                    
                    if (usedLeaveDays + days > leaveLimits[leaveType]) {
                        showToast(`Exceeds ${leaveType} leave balance. Available: ${leaveLimits[leaveType] - usedLeaveDays} days`, 'error');
                        return;
                    }
                }
                
                const leaveId = Date.now();
                leaves.push({
                    id: leaveId,
                    emp: currentUser,
                    type: leaveType,
                    from: fromDate,
                    to: toDate,
                    days: days,
                    status: "Pending",
                    reason: reason,
                    dayType: dayType,
                    appliedDate: new Date().toISOString().split('T')[0]
                });
                
                localStorage.setItem("leaves", JSON.stringify(leaves));
                showToast('Leave application submitted successfully!', 'success');
                resetLeaveForm();
                loadAll();
            }
        }

        function resetLeaveForm() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('fromDate').value = today;
            document.getElementById('toDate').value = today;
            document.getElementById('leaveReason').value = '';
            document.getElementById('leaveType').value = '';
            const fullDayRadio = document.querySelector('input[name="leaveDayType"][value="full"]');
            if (fullDayRadio) fullDayRadio.checked = true;
        }

        async function loadEmpLeaves() {
            if (USE_API) {
                const result = await fetchCall(`get_leaves.php?username=${currentUser}`);
                if (!result || !result.success) return;
                renderLeavesTable(result.leaves);
            } else {
                leaves = JSON.parse(localStorage.getItem("leaves")) || [];
                const myLeaves = leaves.filter(l => l.emp === currentUser);
                renderLeavesTable(myLeaves);
            }
        }

        function renderLeavesTable(leaves) {
            const tableBody = document.querySelector('#empLeaveTable tbody');
            if (!tableBody) return;
            
            let tableHTML = '';
            
            if (leaves.length === 0) {
                tableHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px;">
                            <i class="fas fa-inbox" style="font-size: 48px; color: #cbd5e0; margin-bottom: 15px;"></i>
                            <div style="color: #718096; font-size: 16px;">No leave applications found</div>
                        </td>
                    </tr>
                `;
            } else {
                leaves.sort((a, b) => new Date(b.appliedDate || b.applied_date) - new Date(a.appliedDate || a.applied_date)).forEach(l => {
                    let dayTypeDisplay = (l.day_type || l.dayType) === 'half' ? 'Half Day' : 'Full Day';
                    if (l.from_date !== l.to_date && l.days > 1) {
                        dayTypeDisplay = 'Multiple Days';
                    }
                    
                    const statusBadge = `<span class="status-badge status-${l.status.toLowerCase()}">${l.status}</span>`;
                    
                    let cancelBtn = '';
                    let viewBtn = `<button class="btn-small btn-view" onclick="viewLeaveDetails(${l.id})">
                        <i class="fas fa-eye"></i> View
                    </button>`;
                    
                    if (l.status === "Pending") {
                        cancelBtn = `
                            <button class="btn-small btn-cancel" onclick="cancelLeave(${l.id})">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        `;
                    }
                    
                    tableHTML += `
                        <tr>
                            <td>${l.leave_type || l.type}</td>
                            <td>${l.from_date || l.from}</td>
                            <td>${l.to_date || l.to}</td>
                            <td>${l.days}</td>
                            <td>${statusBadge}</td>
                            <td title="${l.reason}">${l.reason ? (l.reason.length > 50 ? l.reason.substring(0, 50) + '...' : l.reason) : ''}</td>
                            <td>${dayTypeDisplay}</td>
                            <td>
                                <div class="action-buttons">
                                    ${cancelBtn}
                                    ${viewBtn}
                                </div>
                            </td>
                        </tr>
                    `;
                });
            }
            
            tableBody.innerHTML = tableHTML;
        }

        async function cancelLeave(id) {
            if (!confirm('Are you sure you want to cancel this leave application?')) return;
            
            if (USE_API) {
                const result = await fetchCall('cancel_leave.php', 'POST', { 
                    username: currentUser,
                    leave_id: id 
                });
                
                if (result && result.success) {
                    showToast('Leave application cancelled successfully', 'success');
                    loadEmpLeaves();
                    updateDashboardStats();
                }
            } else {
                leaves = JSON.parse(localStorage.getItem("leaves"));
                let leaveIndex = leaves.findIndex(l => l.id === id && l.emp === currentUser);
                
                if (leaveIndex === -1) {
                    showToast('Leave not found', 'error');
                    return;
                }
                
                if (leaves[leaveIndex].status !== "Pending") {
                    showToast('Only pending leaves can be cancelled', 'warning');
                    return;
                }
                
                leaves[leaveIndex].status = "Cancelled";
                localStorage.setItem("leaves", JSON.stringify(leaves));
                
                showToast('Leave application cancelled successfully', 'success');
                loadEmpLeaves();
                loadLeaveBalance();
                updateDashboardStats();
                refreshSystemInfo();
            }
        }

        // ==============================
        // PERMISSION FUNCTIONS
        // ==============================
        async function applyPermission() {
            const date = document.getElementById('permDate').value;
            const hours = document.getElementById('permHours').value;
            const reason = document.getElementById('permReason').value.trim();
            
            if (!date || !hours || !reason) {
                showToast('Please fill all required fields', 'warning');
                return;
            }
            
            if (USE_API) {
                const permData = {
                    username: currentUser,
                    permission_date: date,
                    duration: hours,
                    reason: reason
                };
                
                const result = await fetchCall('apply_permission.php', 'POST', permData);
                
                if (result && result.success) {
                    showToast('Permission request submitted successfully!', 'success');
                    resetPermissionForm();
                    loadPermissions();
                }
            } else {
                permissions = JSON.parse(localStorage.getItem("permissions")) || [];
                
                let hasExistingPermission = false;
                for (let p of permissions) {
                    if (p.emp === currentUser && p.date === date && p.status !== "Rejected" && p.status !== "Cancelled") {
                        hasExistingPermission = true;
                        showToast(`You already have a ${p.status.toLowerCase()} permission request for this date`, 'warning');
                        break;
                    }
                }
                
                if (hasExistingPermission) return;
                
                permissions.push({
                    id: Date.now(),
                    emp: currentUser,
                    date: date,
                    hours: hours,
                    status: "Pending",
                    reason: reason,
                    appliedDate: new Date().toISOString().split('T')[0]
                });
                
                localStorage.setItem("permissions", JSON.stringify(permissions));
                showToast('Permission request submitted successfully!', 'success');
                resetPermissionForm();
                loadPermissions();
                refreshSystemInfo();
            }
        }

        function resetPermissionForm() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('permDate').value = today;
            document.getElementById('permReason').value = '';
            document.getElementById('permHours').value = "1";
        }

        async function loadPermissions() {
            if (USE_API) {
                const result = await fetchCall(`get_permissions.php?username=${currentUser}`);
                if (!result || !result.success) return;
                renderPermissionsTable(result.permissions);
            } else {
                permissions = JSON.parse(localStorage.getItem("permissions")) || [];
                const myPerms = permissions.filter(p => p.emp === currentUser);
                renderPermissionsTable(myPerms);
            }
        }

        function renderPermissionsTable(permissions) {
            const tableBody = document.querySelector('#empPermTable tbody');
            if (!tableBody) return;
            
            let tableHTML = '';
            
            if (permissions.length === 0) {
                tableHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px;">
                            <i class="fas fa-inbox" style="font-size: 48px; color: #cbd5e0; margin-bottom: 15px;"></i>
                            <div style="color: #718096; font-size: 16px;">No permission requests found</div>
                        </td>
                    </tr>
                `;
            } else {
                permissions.sort((a, b) => new Date(b.appliedDate || b.applied_date) - new Date(a.appliedDate || a.applied_date)).forEach(p => {
                    const statusBadge = `<span class="status-badge status-${p.status.toLowerCase()}">${p.status}</span>`;
                    
                    let cancelBtn = '';
                    let viewBtn = `<button class="btn-small btn-view" onclick="viewPermissionDetails(${p.id})">
                        <i class="fas fa-eye"></i> View
                    </button>`;
                    
                    if (p.status === "Pending") {
                        cancelBtn = `
                            <button class="btn-small btn-cancel" onclick="cancelPermission(${p.id})">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        `;
                    }
                    
                    tableHTML += `
                        <tr>
                            <td>${p.permission_date || p.date}</td>
                            <td>${p.duration || p.hours} hours</td>
                            <td>${statusBadge}</td>
                            <td title="${p.reason}">${p.reason ? (p.reason.length > 50 ? p.reason.substring(0, 50) + '...' : p.reason) : ''}</td>
                            <td>
                                <div class="action-buttons">
                                    ${cancelBtn}
                                    ${viewBtn}
                                </div>
                            </td>
                        </tr>
                    `;
                });
            }
            
            tableBody.innerHTML = tableHTML;
        }

        async function cancelPermission(id) {
            if (!confirm('Are you sure you want to cancel this permission request?')) return;
            
            if (USE_API) {
                const result = await fetchCall('cancel_permission.php', 'POST', { 
                    username: currentUser,
                    permission_id: id 
                });
                
                if (result && result.success) {
                    showToast('Permission request cancelled successfully', 'success');
                    loadPermissions();
                }
            } else {
                permissions = JSON.parse(localStorage.getItem("permissions"));
                let permIndex = permissions.findIndex(p => p.id === id && p.emp === currentUser);
                
                if (permIndex === -1) {
                    showToast('Permission not found', 'error');
                    return;
                }
                
                if (permissions[permIndex].status !== "Pending") {
                    showToast('Only pending permissions can be cancelled', 'warning');
                    return;
                }
                
                permissions[permIndex].status = "Cancelled";
                localStorage.setItem("permissions", JSON.stringify(permissions));
                
                showToast('Permission request cancelled successfully', 'success');
                loadPermissions();
                updateDashboardStats();
                refreshSystemInfo();
            }
        }

        // ==============================
        // DASHBOARD FUNCTIONS
        // ==============================
        async function updateDashboardStats() {
            if (USE_API) {
                const result = await fetchCall(`dashboard_stats.php?username=${currentUser}`);
                if (!result || !result.success) return;
                
                const stats = result.stats;
                
                document.getElementById('sickLeaveBalance').textContent = stats.sick_balance || '0';
                document.getElementById('casualLeaveBalance').textContent = stats.casual_balance || '0';
                document.getElementById('otherLeaveBalance').textContent = stats.other_balance || '0';
                document.getElementById('pendingRequests').textContent = stats.pending_requests || '0';
            } else {
                leaves = JSON.parse(localStorage.getItem("leaves")) || [];
                permissions = JSON.parse(localStorage.getItem("permissions")) || [];
                
                const sickLeaves = leaves.filter(l => l.emp === currentUser && l.type === 'Sick' && l.status === 'Approved');
                const casualLeaves = leaves.filter(l => l.emp === currentUser && l.type === 'Casual' && l.status === 'Approved');
                const otherLeaves = leaves.filter(l => l.emp === currentUser && l.type === 'Other' && l.status === 'Approved');
                const pendingLeaves = leaves.filter(l => l.emp === currentUser && l.status === 'Pending');
                const pendingPermissions = permissions.filter(p => p.emp === currentUser && p.status === 'Pending');
                
                const sickUsed = sickLeaves.reduce((sum, l) => sum + parseFloat(l.days), 0);
                const casualUsed = casualLeaves.reduce((sum, l) => sum + parseFloat(l.days), 0);
                const otherUsed = otherLeaves.reduce((sum, l) => sum + parseFloat(l.days), 0);
                
                document.getElementById('sickLeaveBalance').textContent = (leaveLimits.Sick - sickUsed).toFixed(1);
                document.getElementById('casualLeaveBalance').textContent = (leaveLimits.Casual - casualUsed).toFixed(1);
                document.getElementById('otherLeaveBalance').textContent = (leaveLimits.Other - otherUsed).toFixed(1);
                document.getElementById('pendingRequests').textContent = pendingLeaves.length + pendingPermissions.length;
            }
            
            loadLeaveBalance();
        }

        async function loadLeaveBalance() {
            if (USE_API) {
                const result = await fetchCall(`leave_balance.php?username=${currentUser}`);
                if (!result || !result.success) return;
                renderLeaveBalanceTable(result.balance);
            } else {
                leaves = JSON.parse(localStorage.getItem("leaves")) || [];
                let balance = [];
                
                Object.keys(leaveLimits).forEach(t => {
                    let used = 0;
                    leaves.forEach(l => {
                        if (l.emp === currentUser && l.type === t && l.status === "Approved") {
                            used += parseFloat(l.days);
                        }
                    });
                    const remaining = leaveLimits[t] - used;
                    const percentage = leaveLimits[t] > 0 ? Math.round((used / leaveLimits[t]) * 100) : 0;
                    
                    balance.push({
                        leave_type: t,
                        total_days: leaveLimits[t],
                        used_days: used,
                        remaining_days: remaining,
                        percentage: percentage
                    });
                });
                
                renderLeaveBalanceTable(balance);
            }
        }

        function renderLeaveBalanceTable(balance) {
            const tableBody = document.getElementById('leaveBalanceTable');
            if (!tableBody) return;
            
            let balanceHTML = '';
            
            if (balance && balance.length > 0) {
                balance.forEach(b => {
                    const percentage = b.total_days > 0 ? Math.round((b.used_days / b.total_days) * 100) : 0;
                    
                    balanceHTML += `
                        <tr>
                            <td>${b.leave_type} Leave</td>
                            <td>${b.total_days}</td>
                            <td>${b.used_days.toFixed(1)}</td>
                            <td>${(b.total_days - b.used_days).toFixed(1)}</td>
                            <td>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="flex: 1; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
                                        <div style="width: ${percentage}%; height: 100%; background: ${percentage > 80 ? '#f56565' : percentage > 50 ? '#ed8936' : '#48bb78'};"></div>
                                    </div>
                                    <span style="font-weight: 600; color: ${percentage > 80 ? '#f56565' : percentage > 50 ? '#ed8936' : '#48bb78'};">${percentage}%</span>
                                </div>
                            </td>
                        </tr>
                    `;
                });
            } else {
                balanceHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px;">
                            <div class="spinner"></div>
                        </td>
                    </tr>
                `;
            }
            
            tableBody.innerHTML = balanceHTML;
        }

        // ==============================
        // HR PANEL FUNCTIONS
        // ==============================
        async function loadHR() { 
            if (role !== "hr" && role !== "admin" && role !== "pm") {
                showToast('Access denied. HR or Project Manager privileges required.', 'error');
                showPage('dashboard');
                return;
            }
            loadHRLeaves(); 
            loadHRPermissions(); 
        }

        async function loadHRLeaves() {
            if (USE_API) {
                const result = await fetchCall('hr_leaves.php');
                if (!result || !result.success) return;
                renderHRLeavesTable(result.leaves);
            } else {
                leaves = JSON.parse(localStorage.getItem("leaves")) || [];
                let allLeaves = [...leaves]; // Create a copy
                
                // Filter based on current filter
                if (currentLeaveFilter !== 'all') {
                    allLeaves = allLeaves.filter(l => l.status.toLowerCase() === currentLeaveFilter);
                }
                
                renderHRLeavesTable(allLeaves);
            }
        }

        function renderHRLeavesTable(leaves) {
            const tableBody = document.querySelector('#hrLeaveTable tbody');
            if (!tableBody) return;
            
            if (leaves.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 40px;">
                            <i class="fas fa-umbrella-beach" style="font-size: 48px; color: #cbd5e0; margin-bottom: 15px;"></i>
                            <div style="color: #718096; font-size: 16px;">No leave requests found</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let tableHTML = '';
            let totalItems = leaves.length;
            let startIdx = (currentLeavePage - 1) * itemsPerPage;
            let endIdx = Math.min(startIdx + itemsPerPage, totalItems);
            let paginatedLeaves = leaves.slice(startIdx, endIdx);
            
            paginatedLeaves.sort((a, b) => new Date(b.appliedDate || b.applied_date) - new Date(a.appliedDate || a.applied_date)).forEach(l => {
                let dayTypeDisplay = (l.day_type || l.dayType) === 'half' ? 'Half Day' : 'Full Day';
                if (l.from_date !== l.to_date && l.days > 1) {
                    dayTypeDisplay = 'Multiple Days';
                }
                
                const statusBadge = `<span class="status-badge status-${l.status.toLowerCase()}">${l.status}</span>`;
                
                const user = users[l.emp] || {};
                const employeeName = user.name || l.emp;
                
                let actionButtons = '';
                if (l.status === "Pending") {
                    // HR CANNOT APPROVE OR REJECT - ONLY VIEW
                    if (role === "hr") {
                        actionButtons = `
                            <div class="action-buttons">
                                <button class="btn-small btn-approve" disabled>
                                    <i class="fas fa-check"></i> Approve (Disabled for HR)
                                </button>
                                <button class="btn-small btn-reject" disabled>
                                    <i class="fas fa-times"></i> Reject (Disabled for HR)
                                </button>
                                <button class="btn-small btn-view" onclick="viewLeaveDetails(${l.id})">
                                    <i class="fas fa-eye"></i> View
                                </button>
                            </div>
                        `;
                    } else {
                        // Admin and Project Manager can approve/reject
                        actionButtons = `
                            <div class="action-buttons">
                                <button class="btn-small btn-approve" onclick="approveLeave(${l.id})">
                                    <i class="fas fa-check"></i> Approve
                                </button>
                                <button class="btn-small btn-reject" onclick="rejectLeave(${l.id})">
                                    <i class="fas fa-times"></i> Reject
                                </button>
                                <button class="btn-small btn-view" onclick="viewLeaveDetails(${l.id})">
                                    <i class="fas fa-eye"></i> View
                                </button>
                            </div>
                        `;
                    }
                } else {
                    actionButtons = `
                        <div class="action-buttons">
                            <button class="btn-small btn-view" onclick="viewLeaveDetails(${l.id})">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </div>
                    `;
                }
                
                tableHTML += `
                    <tr>
                        <td>${employeeName}</td>
                        <td>${l.leave_type || l.type}</td>
                        <td>${l.from_date || l.from}</td>
                        <td>${l.to_date || l.to}</td>
                        <td>${l.days}</td>
                        <td>${statusBadge}</td>
                        <td title="${l.reason}">${l.reason ? (l.reason.length > 50 ? l.reason.substring(0, 50) + '...' : l.reason) : ''}</td>
                        <td>${dayTypeDisplay}</td>
                        <td>${actionButtons}</td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = tableHTML;
            setupHRLeavePagination(totalItems, currentLeavePage, 'leave');
        }

        async function approveLeave(id) {
            if (!confirm('Are you sure you want to approve this leave?')) return;
            
            // HR cannot approve leaves
            if (role === "hr") {
                showToast('HR managers cannot approve leaves. Only Admins and Project Managers can.', 'error');
                return;
            }
            
            if (USE_API) {
                const result = await fetchCall('approve_leave.php', 'POST', {
                    leave_id: id,
                    approved_by: currentUser
                });
                
                if (result && result.success) {
                    showToast('Leave approved successfully', 'success');
                    loadHRLeaves();
                }
            } else {
                leaves = JSON.parse(localStorage.getItem("leaves"));
                let leaveIndex = leaves.findIndex(l => l.id === id);
                
                if (leaveIndex === -1) {
                    showToast('Leave not found', 'error');
                    return;
                }
                
                if (leaves[leaveIndex].status !== "Pending") {
                    showToast('Only pending leaves can be approved', 'warning');
                    return;
                }
                
                // Check leave balance before approving
                const leave = leaves[leaveIndex];
                if (leave.type !== "Other") {
                    let usedLeaveDays = 0;
                    leaves.forEach(l => {
                        if (l.emp === leave.emp && l.type === leave.type && l.status === "Approved") {
                            usedLeaveDays += parseFloat(l.days);
                        }
                    });
                    
                    if (usedLeaveDays + parseFloat(leave.days) > leaveLimits[leave.type]) {
                        showToast(`Cannot approve: ${leave.emp} would exceed ${leave.type} leave limit`, 'error');
                        return;
                    }
                }
                
                leaves[leaveIndex].status = "Approved";
                leaves[leaveIndex].approvedBy = currentUser;
                leaves[leaveIndex].approvedDate = new Date().toISOString().split('T')[0];
                
                localStorage.setItem("leaves", JSON.stringify(leaves));
                showToast('Leave approved successfully', 'success');
                loadHRLeaves();
                refreshSystemInfo();
            }
        }

        async function rejectLeave(id) {
            if (!confirm('Are you sure you want to reject this leave?')) return;
            
            // HR cannot reject leaves
            if (role === "hr") {
                showToast('HR managers cannot reject leaves. Only Admins and Project Managers can.', 'error');
                return;
            }
            
            if (USE_API) {
                const result = await fetchCall('reject_leave.php', 'POST', {
                    leave_id: id,
                    rejected_by: currentUser
                });
                
                if (result && result.success) {
                    showToast('Leave rejected successfully', 'success');
                    loadHRLeaves();
                }
            } else {
                leaves = JSON.parse(localStorage.getItem("leaves"));
                let leaveIndex = leaves.findIndex(l => l.id === id);
                
                if (leaveIndex === -1) {
                    showToast('Leave not found', 'error');
                    return;
                }
                
                if (leaves[leaveIndex].status !== "Pending") {
                    showToast('Only pending leaves can be rejected', 'warning');
                    return;
                }
                
                leaves[leaveIndex].status = "Rejected";
                leaves[leaveIndex].rejectedBy = currentUser;
                leaves[leaveIndex].rejectedDate = new Date().toISOString().split('T')[0];
                
                localStorage.setItem("leaves", JSON.stringify(leaves));
                showToast('Leave rejected successfully', 'success');
                loadHRLeaves();
                refreshSystemInfo();
            }
        }

        async function loadHRPermissions() {
            if (USE_API) {
                const result = await fetchCall('hr_permissions.php');
                if (!result || !result.success) return;
                renderHRPermissionsTable(result.permissions);
            } else {
                permissions = JSON.parse(localStorage.getItem("permissions")) || [];
                let allPermissions = [...permissions]; // Create a copy
                
                // Filter based on current filter
                if (currentPermFilter !== 'all') {
                    allPermissions = allPermissions.filter(p => p.status.toLowerCase() === currentPermFilter);
                }
                
                renderHRPermissionsTable(allPermissions);
            }
        }

        function renderHRPermissionsTable(permissions) {
            const tableBody = document.querySelector('#hrPermTable tbody');
            if (!tableBody) return;
            
            if (permissions.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px;">
                            <i class="fas fa-clock" style="font-size: 48px; color: #cbd5e0; margin-bottom: 15px;"></i>
                            <div style="color: #718096; font-size: 16px;">No permission requests found</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let tableHTML = '';
            let totalItems = permissions.length;
            let startIdx = (currentPermPage - 1) * itemsPerPage;
            let endIdx = Math.min(startIdx + itemsPerPage, totalItems);
            let paginatedPermissions = permissions.slice(startIdx, endIdx);
            
            paginatedPermissions.sort((a, b) => new Date(b.appliedDate || b.applied_date) - new Date(a.appliedDate || a.applied_date)).forEach(p => {
                const statusBadge = `<span class="status-badge status-${p.status.toLowerCase()}">${p.status}</span>`;
                
                const user = users[p.emp] || {};
                const employeeName = user.name || p.emp;
                
                let actionButtons = '';
                if (p.status === "Pending") {
                    // HR CANNOT APPROVE OR REJECT - ONLY VIEW
                    if (role === "hr") {
                        actionButtons = `
                            <div class="action-buttons">
                                <button class="btn-small btn-approve" disabled>
                                    <i class="fas fa-check"></i> Approve (Disabled for HR)
                                </button>
                                <button class="btn-small btn-reject" disabled>
                                    <i class="fas fa-times"></i> Reject (Disabled for HR)
                                </button>
                                <button class="btn-small btn-view" onclick="viewPermissionDetails(${p.id})">
                                    <i class="fas fa-eye"></i> View
                                </button>
                            </div>
                        `;
                    } else {
                        // Admin and Project Manager can approve/reject
                        actionButtons = `
                            <div class="action-buttons">
                                <button class="btn-small btn-approve" onclick="approvePermission(${p.id})">
                                    <i class="fas fa-check"></i> Approve
                                </button>
                                <button class="btn-small btn-reject" onclick="rejectPermission(${p.id})">
                                    <i class="fas fa-times"></i> Reject
                                </button>
                                <button class="btn-small btn-view" onclick="viewPermissionDetails(${p.id})">
                                    <i class="fas fa-eye"></i> View
                                </button>
                            </div>
                        `;
                    }
                } else {
                    actionButtons = `
                        <div class="action-buttons">
                            <button class="btn-small btn-view" onclick="viewPermissionDetails(${p.id})">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </div>
                    `;
                }
                
                tableHTML += `
                    <tr>
                        <td>${employeeName}</td>
                        <td>${p.permission_date || p.date}</td>
                        <td>${p.duration || p.hours} hours</td>
                        <td>${statusBadge}</td>
                        <td title="${p.reason}">${p.reason ? (p.reason.length > 50 ? p.reason.substring(0, 50) + '...' : p.reason) : ''}</td>
                        <td>${actionButtons}</td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = tableHTML;
            setupHRLeavePagination(totalItems, currentPermPage, 'perm');
        }

        async function approvePermission(id) {
            if (!confirm('Are you sure you want to approve this permission?')) return;
            
            // HR cannot approve permissions
            if (role === "hr") {
                showToast('HR managers cannot approve permissions. Only Admins and Project Managers can.', 'error');
                return;
            }
            
            if (USE_API) {
                const result = await fetchCall('approve_permission.php', 'POST', {
                    permission_id: id,
                    approved_by: currentUser
                });
                
                if (result && result.success) {
                    showToast('Permission approved successfully', 'success');
                    loadHRPermissions();
                }
            } else {
                permissions = JSON.parse(localStorage.getItem("permissions"));
                let permIndex = permissions.findIndex(p => p.id === id);
                
                if (permIndex === -1) {
                    showToast('Permission not found', 'error');
                    return;
                }
                
                if (permissions[permIndex].status !== "Pending") {
                    showToast('Only pending permissions can be approved', 'warning');
                    return;
                }
                
                permissions[permIndex].status = "Approved";
                permissions[permIndex].approvedBy = currentUser;
                permissions[permIndex].approvedDate = new Date().toISOString().split('T')[0];
                
                localStorage.setItem("permissions", JSON.stringify(permissions));
                showToast('Permission approved successfully', 'success');
                loadHRPermissions();
                refreshSystemInfo();
            }
        }

        async function rejectPermission(id) {
            if (!confirm('Are you sure you want to reject this permission?')) return;
            
            // HR cannot reject permissions
            if (role === "hr") {
                showToast('HR managers cannot reject permissions. Only Admins and Project Managers can.', 'error');
                return;
            }
            
            if (USE_API) {
                const result = await fetchCall('reject_permission.php', 'POST', {
                    permission_id: id,
                    rejected_by: currentUser
                });
                
                if (result && result.success) {
                    showToast('Permission rejected successfully', 'success');
                    loadHRPermissions();
                }
            } else {
                permissions = JSON.parse(localStorage.getItem("permissions"));
                let permIndex = permissions.findIndex(p => p.id === id);
                
                if (permIndex === -1) {
                    showToast('Permission not found', 'error');
                    return;
                }
                
                if (permissions[permIndex].status !== "Pending") {
                    showToast('Only pending permissions can be rejected', 'warning');
                    return;
                }
                
                permissions[permIndex].status = "Rejected";
                permissions[permIndex].rejectedBy = currentUser;
                permissions[permIndex].rejectedDate = new Date().toISOString().split('T')[0];
                
                localStorage.setItem("permissions", JSON.stringify(permissions));
                showToast('Permission rejected successfully', 'success');
                loadHRPermissions();
                refreshSystemInfo();
            }
        }

        function viewLeaveDetails(id) {
            let leave;
            if (USE_API) {
                // In API mode, you would need to fetch the leave details
                showToast('Viewing leave details is not available in API mode', 'info');
                return;
            } else {
                leaves = JSON.parse(localStorage.getItem("leaves")) || [];
                leave = leaves.find(l => l.id === id);
                
                if (!leave) {
                    showToast('Leave not found', 'error');
                    return;
                }
            }
            
            const user = users[leave.emp] || {};
            const employeeName = user.name || leave.emp;
            
            let detailsHTML = `
                <div class="modal-detail">
                    <div class="modal-label">Employee</div>
                    <div class="modal-value">${employeeName}</div>
                </div>
                <div class="modal-detail">
                    <div class="modal-label">Leave Type</div>
                    <div class="modal-value">${leave.type}</div>
                </div>
                <div class="modal-detail">
                    <div class="modal-label">From Date</div>
                    <div class="modal-value">${leave.from}</div>
                </div>
                <div class="modal-detail">
                    <div class="modal-label">To Date</div>
                    <div class="modal-value">${leave.to}</div>
                </div>
                <div class="modal-detail">
                    <div class="modal-label">Days</div>
                    <div class="modal-value">${leave.days}</div>
                </div>
                <div class="modal-detail">
                    <div class="modal-label">Day Type</div>
                    <div class="modal-value">${leave.dayType === 'half' ? 'Half Day' : 'Full Day'}</div>
                </div>
                <div class="modal-detail">
                    <div class="modal-label">Status</div>
                    <div class="modal-value"><span class="status-badge status-${leave.status.toLowerCase()}">${leave.status}</span></div>
                </div>
                <div class="modal-detail">
                    <div class="modal-label">Reason</div>
                    <div class="modal-value">${leave.reason}</div>
                </div>
                <div class="modal-detail">
                    <div class="modal-label">Applied Date</div>
                    <div class="modal-value">${leave.appliedDate || 'N/A'}</div>
                </div>
            `;
            
            if (leave.approvedBy) {
                detailsHTML += `
                    <div class="modal-detail">
                        <div class="modal-label">Approved By</div>
                        <div class="modal-value">${users[leave.approvedBy]?.name || leave.approvedBy}</div>
                    </div>
                    <div class="modal-detail">
                        <div class="modal-label">Approved Date</div>
                        <div class="modal-value">${leave.approvedDate || 'N/A'}</div>
                    </div>
                `;
            }
            
            if (leave.rejectedBy) {
                detailsHTML += `
                    <div class="modal-detail">
                        <div class="modal-label">Rejected By</div>
                        <div class="modal-value">${users[leave.rejectedBy]?.name || leave.rejectedBy}</div>
                    </div>
                    <div class="modal-detail">
                        <div class="modal-label">Rejected Date</div>
                        <div class="modal-value">${leave.rejectedDate || 'N/A'}</div>
                    </div>
                `;
            }
            
            document.getElementById('leaveDetailsContent').innerHTML = detailsHTML;
            openModal('leaveDetailsModal');
        }

        function viewPermissionDetails(id) {
            let permission;
            if (USE_API) {
                // In API mode, you would need to fetch the permission details
                showToast('Viewing permission details is not available in API mode', 'info');
                return;
            } else {
                permissions = JSON.parse(localStorage.getItem("permissions")) || [];
                permission = permissions.find(p => p.id === id);
                
                if (!permission) {
                    showToast('Permission not found', 'error');
                    return;
                }
            }
            
            const user = users[permission.emp] || {};
            const employeeName = user.name || permission.emp;
            
            let detailsHTML = `
                <div class="modal-detail">
                    <div class="modal-label">Employee</div>
                    <div class="modal-value">${employeeName}</div>
                </div>
                <div class="modal-detail">
                    <div class="modal-label">Date</div>
                    <div class="modal-value">${permission.date}</div>
                </div>
                <div class="modal-detail">
                    <div class="modal-label">Duration</div>
                    <div class="modal-value">${permission.hours} hours</div>
                </div>
                <div class="modal-detail">
                    <div class="modal-label">Status</div>
                    <div class="modal-value"><span class="status-badge status-${permission.status.toLowerCase()}">${permission.status}</span></div>
                </div>
                <div class="modal-detail">
                    <div class="modal-label">Reason</div>
                    <div class="modal-value">${permission.reason}</div>
                </div>
                <div class="modal-detail">
                    <div class="modal-label">Applied Date</div>
                    <div class="modal-value">${permission.appliedDate || 'N/A'}</div>
                </div>
            `;
            
            if (permission.approvedBy) {
                detailsHTML += `
                    <div class="modal-detail">
                        <div class="modal-label">Approved By</div>
                        <div class="modal-value">${users[permission.approvedBy]?.name || permission.approvedBy}</div>
                    </div>
                    <div class="modal-detail">
                        <div class="modal-label">Approved Date</div>
                        <div class="modal-value">${permission.approvedDate || 'N/A'}</div>
                    </div>
                `;
            }
            
            if (permission.rejectedBy) {
                detailsHTML += `
                    <div class="modal-detail">
                        <div class="modal-label">Rejected By</div>
                        <div class="modal-value">${users[permission.rejectedBy]?.name || permission.rejectedBy}</div>
                    </div>
                    <div class="modal-detail">
                        <div class="modal-label">Rejected Date</div>
                        <div class="modal-value">${permission.rejectedDate || 'N/A'}</div>
                    </div>
                `;
            }
            
            document.getElementById('permissionDetailsContent').innerHTML = detailsHTML;
            openModal('permissionDetailsModal');
        }

        function filterLeaves() {
            currentLeaveFilter = document.getElementById('leaveFilter').value;
            currentLeavePage = 1;
            loadHRLeaves();
            showToast(`Filtered leaves: ${currentLeaveFilter}`, 'info');
        }

        function filterPermissions() {
            currentPermFilter = document.getElementById('permFilter').value;
            currentPermPage = 1;
            loadHRPermissions();
            showToast(`Filtered permissions: ${currentPermFilter}`, 'info');
        }

        function setupHRLeavePagination(totalItems, currentPage, type) {
            const paginationDiv = type === 'leave' ? document.getElementById('leavePagination') : document.getElementById('permPagination');
            if (!paginationDiv) return;
            
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            
            if (totalPages <= 1) {
                paginationDiv.innerHTML = '';
                return;
            }
            
            let paginationHTML = '';
            
            // Previous button
            paginationHTML += `
                <button ${currentPage === 1 ? 'disabled' : ''} onclick="changeHRPage(${currentPage - 1}, '${type}')">
                    <i class="fas fa-chevron-left"></i>
                </button>
            `;
            
            // Page numbers
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <button ${i === currentPage ? 'class="active"' : ''} onclick="changeHRPage(${i}, '${type}')">
                        ${i}
                    </button>
                `;
            }
            
            // Next button
            paginationHTML += `
                <button ${currentPage === totalPages ? 'disabled' : ''} onclick="changeHRPage(${currentPage + 1}, '${type}')">
                    <i class="fas fa-chevron-right"></i>
                </button>
            `;
            
            // Page info
            const startItem = (currentPage - 1) * itemsPerPage + 1;
            const endItem = Math.min(currentPage * itemsPerPage, totalItems);
            paginationHTML += `
                <div class="pagination-info">
                    Showing ${startItem}-${endItem} of ${totalItems}
                </div>
            `;
            
            paginationDiv.innerHTML = paginationHTML;
        }

        function changeHRPage(page, type) {
            if (type === 'leave') {
                currentLeavePage = page;
                loadHRLeaves();
            } else if (type === 'perm') {
                currentPermPage = page;
                loadHRPermissions();
            }
        }

        // ==============================
        // EXPORT FUNCTIONS
        // ==============================
        function exportLeavesExcel() {
            try {
                leaves = JSON.parse(localStorage.getItem("leaves")) || [];
                if (leaves.length === 0) {
                    showToast('No leave data to export', 'warning');
                    return;
                }
                
                // Prepare data for Excel
                const excelData = leaves.map(leave => {
                    const user = users[leave.emp] || {};
                    return {
                        'Employee ID': leave.emp,
                        'Employee Name': user.name || leave.emp,
                        'Leave Type': leave.type,
                        'From Date': leave.from,
                        'To Date': leave.to,
                        'Days': leave.days,
                        'Status': leave.status,
                        'Reason': leave.reason,
                        'Day Type': leave.dayType === 'half' ? 'Half Day' : 'Full Day',
                        'Applied Date': leave.appliedDate || '',
                        'Approved/Rejected By': leave.approvedBy || leave.rejectedBy || '',
                        'Action Date': leave.approvedDate || leave.rejectedDate || ''
                    };
                });
                
                const worksheet = XLSX.utils.json_to_sheet(excelData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Leaves");
                
                const now = new Date();
                const dateStr = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')}`;
                const filename = `MAKSIM_Leaves_Report_${dateStr}.xlsx`;
                
                XLSX.writeFile(workbook, filename);
                showToast('Leaves exported to Excel successfully!', 'success');
            } catch (error) {
                console.error('Export error:', error);
                showToast('Error exporting leaves to Excel', 'error');
            }
        }

        function exportPermissionsExcel() {
            try {
                permissions = JSON.parse(localStorage.getItem("permissions")) || [];
                if (permissions.length === 0) {
                    showToast('No permission data to export', 'warning');
                    return;
                }
                
                // Prepare data for Excel
                const excelData = permissions.map(perm => {
                    const user = users[perm.emp] || {};
                    return {
                        'Employee ID': perm.emp,
                        'Employee Name': user.name || perm.emp,
                        'Date': perm.date,
                        'Duration (hours)': perm.hours,
                        'Status': perm.status,
                        'Reason': perm.reason,
                        'Applied Date': perm.appliedDate || '',
                        'Approved/Rejected By': perm.approvedBy || perm.rejectedBy || '',
                        'Action Date': perm.approvedDate || perm.rejectedDate || ''
                    };
                });
                
                const worksheet = XLSX.utils.json_to_sheet(excelData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Permissions");
                
                const now = new Date();
                const dateStr = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')}`;
                const filename = `MAKSIM_Permissions_Report_${dateStr}.xlsx`;
                
                XLSX.writeFile(workbook, filename);
                showToast('Permissions exported to Excel successfully!', 'success');
            } catch (error) {
                console.error('Export error:', error);
                showToast('Error exporting permissions to Excel', 'error');
            }
        }

        function generateReport() {
            showToast('Report generation functionality will be implemented soon', 'info');
        }

        // ==============================
        // CHANGE PASSWORD FUNCTION
        // ==============================
        function changePassword() {
            const oldPass = document.getElementById('oldPass').value;
            const newPass = document.getElementById('newPass').value;
            const confirmNewPass = document.getElementById('confirmNewPass').value;
            
            if (!oldPass || !newPass || !confirmNewPass) {
                showToast('Please fill all password fields', 'warning');
                return;
            }
            
            if (newPass !== confirmNewPass) {
                showToast('New password and confirm password do not match', 'error');
                return;
            }
            
            if (newPass.length < 6) {
                showToast('New password must be at least 6 characters long', 'warning');
                return;
            }
            
            if (USE_API) {
                apiChangePassword(oldPass, newPass);
            } else {
                if (users[currentUser].password !== oldPass) {
                    showToast('Current password is incorrect', 'error');
                    return;
                }
                
                users[currentUser].password = newPass;
                localStorage.setItem("users", JSON.stringify(users));
                
                showToast('Password changed successfully', 'success');
                
                document.getElementById('oldPass').value = '';
                document.getElementById('newPass').value = '';
                document.getElementById('confirmNewPass').value = '';
            }
        }

        async function apiChangePassword(oldPass, newPass) {
            const result = await fetchCall('change_password.php', 'POST', {
                username: currentUser,
                old_password: oldPass,
                new_password: newPass
            });
            
            if (result && result.success) {
                showToast('Password changed successfully', 'success');
                document.getElementById('oldPass').value = '';
                document.getElementById('newPass').value = '';
                document.getElementById('confirmNewPass').value = '';
            }
        }

        // ==============================
        // ATTENDANCE FUNCTIONS
        // ==============================
        function markAttendance() {
            const today = new Date().toISOString().split('T')[0];
            
            if (USE_API) {
                apiMarkAttendance(today);
            } else {
                let attendance = JSON.parse(localStorage.getItem("attendance")) || [];
                
                // Check if already marked
                const existing = attendance.find(a => a.emp === currentUser && a.date === today);
                if (existing) {
                    showToast('Attendance already marked for today', 'info');
                    return;
                }
                
                attendance.push({
                    emp: currentUser,
                    date: today,
                    status: "Present",
                    markedAt: new Date().toISOString()
                });
                
                localStorage.setItem("attendance", JSON.stringify(attendance));
                showToast('Attendance marked successfully for today!', 'success');
                
                const attendanceStatus = document.getElementById('attendanceStatus');
                if (attendanceStatus) {
                    attendanceStatus.innerHTML = `
                        <div class="status-badge status-present">
                            <i class="fas fa-check-circle"></i> Marked as Present
                        </div>
                        <p style="margin-top: 10px; color: #718096;">Attendance recorded at: ${new Date().toLocaleTimeString()}</p>
                    `;
                }
            }
        }

        async function apiMarkAttendance(date) {
            const result = await fetchCall('mark_attendance.php', 'POST', {
                username: currentUser,
                date: date
            });
            
            if (result && result.success) {
                showToast('Attendance marked successfully for today!', 'success');
                const attendanceStatus = document.getElementById('attendanceStatus');
                if (attendanceStatus) {
                    attendanceStatus.innerHTML = `
                        <div class="status-badge status-present">
                            <i class="fas fa-check-circle"></i> Marked as Present
                        </div>
                        <p style="margin-top: 10px; color: #718096;">Attendance recorded at: ${new Date().toLocaleTimeString()}</p>
                    `;
                }
            }
        }

        // ==============================
        // ATTENDANCE REPORT FUNCTIONS (Partially implemented)
        // ==============================
        function loadUploadedFiles() {
            uploadedFiles = JSON.parse(localStorage.getItem("uploadedFiles")) || [];
            const fileList = document.getElementById('uploadedFilesList');
            if (!fileList) return;
            
            if (uploadedFiles.length === 0) {
                fileList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #718096;">
                        <i class="fas fa-folder-open" style="font-size: 48px; margin-bottom: 10px;"></i>
                        <div>No files uploaded yet</div>
                    </div>
                `;
                return;
            }
            
            let fileHTML = '';
            uploadedFiles.sort((a, b) => new Date(b.uploadDate) - new Date(a.uploadDate)).forEach(file => {
                const uploadDate = new Date(file.uploadDate).toLocaleString();
                const fileSize = (file.size / 1024).toFixed(2) + ' KB';
                
                fileHTML += `
                    <div class="file-item">
                        <div class="file-icon">
                            <i class="fas fa-file-excel"></i>
                        </div>
                        <div class="file-details">
                            <div class="file-name">${file.name}</div>
                            <div class="file-meta">
                                <span><i class="fas fa-calendar"></i> ${uploadDate}</span>
                                <span><i class="fas fa-hdd"></i> ${fileSize}</span>
                                <span><i class="fas fa-user"></i> ${file.uploadedBy}</span>
                                <span><i class="fas fa-list"></i> ${file.recordCount} records</span>
                            </div>
                        </div>
                        <div class="file-actions">
                            <button class="btn-small btn-success" onclick="processAttendanceFile('${file.name}')">
                                <i class="fas fa-sync-alt"></i> Process
                            </button>
                            <button class="btn-small btn-danger" onclick="deleteUploadedFile(${file.id})">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                `;
            });
            
            fileList.innerHTML = fileHTML;
        }

        function processAttendanceFile(filename) {
            showToast(`Processing ${filename}...`, 'info');
            // This would process the file data from localStorage
            loadAttendanceReport();
        }

        function deleteUploadedFile(fileId) {
            if (!confirm('Are you sure you want to delete this uploaded file?')) return;
            
            uploadedFiles = uploadedFiles.filter(file => file.id !== fileId);
            localStorage.setItem("uploadedFiles", JSON.stringify(uploadedFiles));
            loadUploadedFiles();
            showToast('File deleted successfully', 'success');
        }

        function loadAttendanceReport() {
            // This would load attendance data from localStorage or API
            // For now, just show a message
            const attendanceBody = document.getElementById('attendanceTableBody');
            if (!attendanceBody) return;
            
            attendanceBody.innerHTML = `
                <tr>
                    <td colspan="31" style="text-align: center; padding: 40px;">
                        <div class="no-timesheet">
                            <i class="fas fa-calendar-alt"></i>
                            <div>Attendance report functionality will be implemented in the next update</div>
                        </div>
                    </td>
                </tr>
            `;
        }

        // ==============================
        // TIMESHEET FUNCTIONS
        // ==============================
        function updateTimesheetUserDisplay() {
            const hrUserSelectContainer = document.getElementById('hrUserSelectContainer');
            const timesheetCurrentUser = document.getElementById('timesheetCurrentUser');
            const timesheetReportingTo = document.getElementById('timesheetReportingTo');
            
            if (!hrUserSelectContainer || !timesheetCurrentUser || !timesheetReportingTo) return;
            
            const currentUserInfo = users[currentUser];
            
            if (role === "hr" || role === "admin" || role === "pm") {
                hrUserSelectContainer.classList.remove('hidden');
                
                const userSelect = document.getElementById('timesheetUserSelect');
                if (userSelect) {
                    userSelect.innerHTML = '';
                    
                    Object.keys(users).forEach(username => {
                        const user = users[username];
                        const option = document.createElement('option');
                        option.value = username;
                        option.textContent = `${user.name} (${username})`;
                        if (username === currentUser) {
                            option.selected = true;
                        }
                        userSelect.appendChild(option);
                    });
                    
                    userSelect.onchange = function() {
                        selectedTimesheetUser = this.value;
                        updateTimesheetUserInfoDisplay();
                        loadTimesheetData();
                    };
                    
                    if (!selectedTimesheetUser) {
                        selectedTimesheetUser = currentUser;
                        userSelect.value = currentUser;
                    } else {
                        userSelect.value = selectedTimesheetUser;
                    }
                }
                
                updateTimesheetUserInfoDisplay();
            } else {
                hrUserSelectContainer.classList.add('hidden');
                
                if (currentUserInfo) {
                    timesheetCurrentUser.textContent = currentUserInfo.name || currentUser;
                    timesheetReportingTo.textContent = users[currentUserInfo.reportingTo]?.name || currentUserInfo.reportingTo || 'Not assigned';
                }
                
                selectedTimesheetUser = currentUser;
            }
        }

        function updateTimesheetUserInfoDisplay() {
            const timesheetCurrentUser = document.getElementById('timesheetCurrentUser');
            const timesheetReportingTo = document.getElementById('timesheetReportingTo');
            
            if (!timesheetCurrentUser || !timesheetReportingTo) return;
            
            const userToDisplay = selectedTimesheetUser || currentUser;
            const userInfo = users[userToDisplay];
            
            if (userInfo) {
                timesheetCurrentUser.textContent = userInfo.name || userToDisplay;
                timesheetReportingTo.textContent = users[userInfo.reportingTo]?.name || userInfo.reportingTo || 'Not assigned';
            }
        }

        function initializeTimesheetForm() {
            const timesheetForm = document.getElementById('timesheetForm');
            if (!timesheetForm) return;
            
            timesheetForm.innerHTML = '';
            timesheetRowCounter = 1;
            addTimesheetRow();
        }

        function addTimesheetRow() {
            const timesheetForm = document.getElementById('timesheetForm');
            if (!timesheetForm) return;
            
            const today = new Date().toISOString().split('T')[0];
            
            const row = document.createElement('div');
            row.className = 'timesheet-row';
            row.id = `timesheet-row-${timesheetRowCounter}`;
            
            row.innerHTML = `
                <div class="timesheet-field">
                    <label class="form-label">Date</label>
                    <input type="date" class="form-control timesheet-date" value="${today}">
                </div>
                <div class="timesheet-field-small">
                    <label class="form-label">Hours</label>
                    <div class="time-input">
                        <input type="number" class="form-control timesheet-hours" placeholder="HH" min="0" max="23" value="8">
                        <span class="time-separator">:</span>
                        <input type="number" class="form-control timesheet-minutes" placeholder="MM" min="0" max="59" value="0">
                    </div>
                </div>
                <div class="timesheet-field">
                    <label class="form-label">Project Name</label>
                    <input type="text" class="form-control timesheet-project" placeholder="Enter project name">
                </div>
                <div class="timesheet-field">
                    <label class="form-label">Module Name</label>
                    <input type="text" class="form-control timesheet-module" placeholder="Enter module name">
                </div>
                <div class="timesheet-field">
                    <label class="form-label">Sub Module</label>
                    <input type="text" class="form-control timesheet-submodule" placeholder="Enter sub module">
                </div>
                <div class="timesheet-field">
                    <label class="form-label">Task Name</label>
                    <input type="text" class="form-control timesheet-task" placeholder="Enter task name">
                </div>
                <div class="timesheet-field">
                    <label class="form-label">Remarks</label>
                    <input type="text" class="form-control timesheet-remarks" placeholder="Enter remarks">
                </div>
                <div class="timesheet-field">
                    <label class="form-label">Status</label>
                    <select class="form-control timesheet-status">
                        <option value="inprogress">In Progress</option>
                        <option value="completed" selected>Completed</option>
                        <option value="notstarted">Not Started</option>
                    </select>
                </div>
                <div class="timesheet-field-small">
                    <label class="form-label">Actions</label>
                    <button class="btn-delete" onclick="removeTimesheetRow(${timesheetRowCounter})">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            `;
            
            timesheetForm.appendChild(row);
            timesheetRowCounter++;
            updateTimesheetTotal();
        }

        function removeTimesheetRow(rowId) {
            const row = document.getElementById(`timesheet-row-${rowId}`);
            if (row) {
                row.remove();
                updateTimesheetTotal();
                showToast('Timesheet row removed', 'info');
            }
        }

        function updateTimesheetTotal() {
            const hourInputs = document.querySelectorAll('.timesheet-hours');
            const minuteInputs = document.querySelectorAll('.timesheet-minutes');
            
            let totalHours = 0;
            let totalMinutes = 0;
            
            hourInputs.forEach((input, index) => {
                const hours = parseInt(input.value) || 0;
                const minutes = parseInt(minuteInputs[index].value) || 0;
                
                totalHours += hours;
                totalMinutes += minutes;
            });
            
            totalHours += Math.floor(totalMinutes / 60);
            totalMinutes = totalMinutes % 60;
            
            const totalHoursElement = document.getElementById('totalHours');
            if (totalHoursElement) {
                totalHoursElement.textContent = `${totalHours}.${totalMinutes.toString().padStart(2, '0')}`;
            }
            
            const totalElement = document.getElementById('timesheetTotal');
            if (totalElement) {
                if (totalHours > 0 || totalMinutes > 0) {
                    totalElement.classList.remove('hidden');
                } else {
                    totalElement.classList.add('hidden');
                }
            }
        }

        async function submitTimesheet() {
            const submittingUser = selectedTimesheetUser || currentUser;
            const submittingUserInfo = users[submittingUser];
            
            if (!submittingUserInfo) {
                showToast('User information not found', 'error');
                return;
            }
            
            const rows = document.querySelectorAll('.timesheet-row');
            
            if (rows.length === 0) {
                showToast('Please add at least one timesheet entry', 'warning');
                return;
            }
            
            const entries = [];
            let hasError = false;
            
            rows.forEach((row, index) => {
                const date = row.querySelector('.timesheet-date').value;
                const hours = row.querySelector('.timesheet-hours').value;
                const minutes = row.querySelector('.timesheet-minutes').value;
                const project = row.querySelector('.timesheet-project').value;
                const module = row.querySelector('.timesheet-module').value;
                const submodule = row.querySelector('.timesheet-submodule').value;
                const task = row.querySelector('.timesheet-task').value;
                const remarks = row.querySelector('.timesheet-remarks').value;
                const status = row.querySelector('.timesheet-status').value;
                
                if (!date || !hours || !project || !module || !task) {
                    hasError = true;
                    showToast(`Please fill all required fields in row ${index + 1}`, 'error');
                    return;
                }
                
                const totalHours = parseFloat(hours) + (parseFloat(minutes) / 60);
                
                entries.push({
                    username: submittingUser,
                    entry_date: date,
                    hours: totalHours.toFixed(2),
                    project_name: project,
                    module_name: module,
                    sub_module: submodule,
                    task_name: task,
                    remarks: remarks,
                    status: status
                });
            });
            
            if (hasError) return;
            
            if (USE_API) {
                const result = await fetchCall('submit_timesheet.php', 'POST', { entries });
                
                if (result && result.success) {
                    showToast('Timesheet submitted successfully!', 'success');
                    initializeTimesheetForm();
                    loadTimesheetData();
                }
            } else {
                timesheetData = JSON.parse(localStorage.getItem("timesheetData")) || [];
                entries.forEach(entry => {
                    timesheetData.push({
                        id: Date.now(),
                        emp: submittingUser,
                        reportingTo: submittingUserInfo.reportingTo,
                        date: entry.entry_date,
                        hours: entry.hours,
                        project: entry.project_name,
                        module: entry.module_name,
                        subModule: entry.sub_module,
                        task: entry.task_name,
                        remarks: entry.remarks,
                        status: entry.status,
                        submittedDate: new Date().toISOString().split('T')[0],
                        submittedBy: currentUser
                    });
                });
                
                localStorage.setItem("timesheetData", JSON.stringify(timesheetData));
                showToast('Timesheet submitted successfully!', 'success');
                initializeTimesheetForm();
                loadTimesheetData();
                refreshSystemInfo();
            }
        }

        async function loadTimesheetData() {
            const today = new Date().toISOString().split('T')[0];
            const viewingUser = selectedTimesheetUser || currentUser;
            
            if (USE_API) {
                const result = await fetchCall(`get_timesheet.php?username=${viewingUser}&date=${today}`);
                if (!result || !result.success) return;
                renderTimesheetTable(result.timesheets);
            } else {
                const userEntries = timesheetData.filter(entry => 
                    entry.emp === viewingUser && 
                    entry.date === today
                );
                renderTimesheetTable(userEntries);
            }
        }

        function renderTimesheetTable(entries) {
            const tableBody = document.getElementById('timesheetTableBody');
            if (!tableBody) return;
            
            if (entries.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 40px;">
                            <div class="no-timesheet">
                                <i class="fas fa-clock"></i>
                                <div>No timesheet entries for today. Add your entries above.</div>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let tableHTML = '';
            let totalHours = 0;
            
            entries.forEach(entry => {
                const hours = parseFloat(entry.hours);
                const wholeHours = Math.floor(hours);
                const minutes = Math.round((hours - wholeHours) * 60);
                
                let statusBadge = '';
                switch(entry.status) {
                    case 'completed':
                        statusBadge = '<span class="status-badge status-completed">Completed</span>';
                        break;
                    case 'inprogress':
                        statusBadge = '<span class="status-badge status-inprogress">In Progress</span>';
                        break;
                    case 'notstarted':
                        statusBadge = '<span class="status-badge status-notstarted">Not Started</span>';
                        break;
                }
                
                let deleteButton = '';
                if (entry.emp === currentUser || role === 'hr' || role === 'admin' || role === 'pm') {
                    deleteButton = `
                        <button class="btn-small btn-delete" onclick="deleteTimesheetEntry(${entry.id})">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    `;
                }
                
                tableHTML += `
                    <tr>
                        <td>${entry.entry_date || entry.date}</td>
                        <td>${wholeHours}h ${minutes}m</td>
                        <td>${entry.project_name || entry.project}</td>
                        <td>${entry.module_name || entry.module}</td>
                        <td>${entry.sub_module || entry.subModule || '-'}</td>
                        <td>${entry.task_name || entry.task}</td>
                        <td title="${entry.remarks}">${entry.remarks ? (entry.remarks.length > 50 ? entry.remarks.substring(0, 50) + '...' : entry.remarks) : '-'}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <div class="action-buttons">
                                ${deleteButton}
                            </div>
                        </td>
                    </tr>
                `;
                
                totalHours += hours;
            });
            
            tableBody.innerHTML = tableHTML;
            
            const totalElement = document.getElementById('timesheetTotal');
            if (totalHours > 0) {
                const wholeHours = Math.floor(totalHours);
                const minutes = Math.round((totalHours - wholeHours) * 60);
                const totalHoursElement = document.getElementById('totalHours');
                if (totalHoursElement) {
                    totalHoursElement.textContent = `${wholeHours}.${minutes.toString().padStart(2, '0')}`;
                }
                if (totalElement) {
                    totalElement.classList.remove('hidden');
                }
            } else if (totalElement) {
                totalElement.classList.add('hidden');
            }
        }

        async function deleteTimesheetEntry(id) {
            if (!confirm('Are you sure you want to delete this timesheet entry?')) return;
            
            if (USE_API) {
                const result = await fetchCall('delete_timesheet.php', 'POST', { 
                    id: id,
                    username: currentUser 
                });
                
                if (result && result.success) {
                    showToast('Timesheet entry deleted successfully', 'success');
                    loadTimesheetData();
                }
            } else {
                timesheetData = timesheetData.filter(entry => entry.id !== id);
                localStorage.setItem("timesheetData", JSON.stringify(timesheetData));
                
                showToast('Timesheet entry deleted successfully', 'success');
                loadTimesheetData();
                refreshSystemInfo();
            }
        }

        // ==============================
        // SYSTEM ADMINISTRATION FUNCTIONS
        // ==============================
        function showClearDataConfirm() {
            const confirmDiv = document.getElementById('clearDataConfirm');
            if (confirmDiv) {
                confirmDiv.classList.remove('hidden');
            }
            const confirmInput = document.getElementById('clearDataConfirmInput');
            if (confirmInput) {
                confirmInput.focus();
            }
        }

        function hideClearDataConfirm() {
            const confirmDiv = document.getElementById('clearDataConfirm');
            if (confirmDiv) {
                confirmDiv.classList.add('hidden');
            }
            const confirmInput = document.getElementById('clearDataConfirmInput');
            if (confirmInput) {
                confirmInput.value = '';
            }
        }

        async function clearAllData() {
            const confirmText = document.getElementById('clearDataConfirmInput').value;
            
            if (confirmText !== "RESET SYSTEM") {
                showToast('Please type "RESET SYSTEM" exactly to confirm', 'error');
                return;
            }
            
            if (USE_API) {
                const result = await fetchCall('clear_all_data.php', 'POST', {
                    confirm: confirmText,
                    username: currentUser
                });
                
                if (result && result.success) {
                    hideClearDataConfirm();
                    showToast('All system data has been cleared. System reset to factory defaults.', 'success');
                    
                    if (role !== "admin" && role !== "hr" && role !== "pm") {
                        setTimeout(() => {
                            showToast('Your account has been removed. Please login with admin credentials.', 'warning');
                            logout();
                        }, 2000);
                    } else {
                        loadAll();
                        refreshSystemInfo();
                    }
                }
            } else {
                localStorage.removeItem("leaves");
                localStorage.removeItem("permissions");
                localStorage.removeItem("timesheetData");
                localStorage.removeItem("attendance");
                localStorage.removeItem("attendanceData");
                localStorage.removeItem("uploadedFiles");
                
                users = JSON.parse(JSON.stringify(defaultUsers));
                localStorage.setItem("users", JSON.stringify(users));
                
                timesheetData = [];
                attendanceData = [];
                uploadedFiles = [];
                
                hideClearDataConfirm();
                showToast('All system data has been cleared. System reset to factory defaults.', 'success');
                
                if (!users[currentUser]) {
                    setTimeout(() => {
                        showToast('Your account has been removed. Please login with default admin credentials.', 'warning');
                        logout();
                    }, 2000);
                } else {
                    loadAll();
                    refreshSystemInfo();
                }
            }
        }

        async function exportAllData() {
            if (USE_API) {
                const result = await fetchCall('export_all_data.php');
                
                if (result && result.success && result.download_url) {
                    const a = document.createElement('a');
                    a.href = result.download_url;
                    a.download = result.filename || 'MAKSIM_System_Backup.xlsx';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    showToast('All data exported successfully!', 'success');
                }
            } else {
                const allData = {
                    users: JSON.parse(localStorage.getItem("users")) || {},
                    leaves: JSON.parse(localStorage.getItem("leaves")) || [],
                    permissions: JSON.parse(localStorage.getItem("permissions")) || [],
                    timesheetData: JSON.parse(localStorage.getItem("timesheetData")) || [],
                    attendance: JSON.parse(localStorage.getItem("attendance")) || [],
                    attendanceData: JSON.parse(localStorage.getItem("attendanceData")) || [],
                    uploadedFiles: JSON.parse(localStorage.getItem("uploadedFiles")) || [],
                    exportedAt: new Date().toISOString(),
                    system: "MAKSIM HR System"
                };
                
                const jsonData = JSON.stringify(allData, null, 2);
                const blob = new Blob([jsonData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                
                const now = new Date();
                const dateStr = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')}`;
                const filename = `MAKSIM_System_Backup_${dateStr}.json`;
                
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showToast(`All data exported to ${filename} successfully!`, 'success');
            }
        }

        async function refreshSystemInfo() {
            if (USE_API) {
                const result = await fetchCall('system_info.php');
                
                if (!result || !result.success) return;
                
                const info = result.info;
                
                document.getElementById('totalUsers').textContent = info.total_users || '0';
                document.getElementById('totalLeavesCount').textContent = info.total_leaves || '0';
                document.getElementById('totalPermissions').textContent = info.total_permissions || '0';
                document.getElementById('totalTimesheets').textContent = info.total_timesheets || '0';
                document.getElementById('totalAttendance').textContent = info.total_attendance || '0';
                
                let storageText = '';
                const size = info.storage_used || 0;
                if (size < 1024) {
                    storageText = `${size} bytes`;
                } else if (size < 1024 * 1024) {
                    storageText = `${(size / 1024).toFixed(2)} KB`;
                } else {
                    storageText = `${(size / (1024 * 1024)).toFixed(2)} MB`;
                }
                document.getElementById('storageUsed').textContent = storageText;
            } else {
                const usersData = JSON.parse(localStorage.getItem("users")) || {};
                const leavesData = JSON.parse(localStorage.getItem("leaves")) || [];
                const permissionsData = JSON.parse(localStorage.getItem("permissions")) || [];
                const timesheetData = JSON.parse(localStorage.getItem("timesheetData")) || [];
                const attendanceData = JSON.parse(localStorage.getItem("attendance")) || [];
                const attendanceReportData = JSON.parse(localStorage.getItem("attendanceData")) || [];
                const uploadedFilesData = JSON.parse(localStorage.getItem("uploadedFiles")) || [];
                
                let totalSize = 0;
                totalSize += JSON.stringify(usersData).length;
                totalSize += JSON.stringify(leavesData).length;
                totalSize += JSON.stringify(permissionsData).length;
                totalSize += JSON.stringify(timesheetData).length;
                totalSize += JSON.stringify(attendanceData).length;
                totalSize += JSON.stringify(attendanceReportData).length;
                totalSize += JSON.stringify(uploadedFilesData).length;
                
                document.getElementById('totalUsers').textContent = Object.keys(usersData).length;
                document.getElementById('totalLeavesCount').textContent = leavesData.length;
                document.getElementById('totalPermissions').textContent = permissionsData.length;
                document.getElementById('totalTimesheets').textContent = timesheetData.length;
                document.getElementById('totalAttendance').textContent = attendanceReportData.length;
                
                let storageText = '';
                if (totalSize < 1024) {
                    storageText = `${totalSize} bytes`;
                } else if (totalSize < 1024 * 1024) {
                    storageText = `${(totalSize / 1024).toFixed(2)} KB`;
                } else {
                    storageText = `${(totalSize / (1024 * 1024)).toFixed(2)} MB`;
                }
                document.getElementById('storageUsed').textContent = storageText;
                
                const lastUpdated = document.getElementById('lastUpdated');
                if (lastUpdated) {
                    lastUpdated.textContent = new Date().toLocaleTimeString();
                }
            }
        }

        // ==============================
        // INITIALIZE EVENT LISTENERS
        // ==============================
        document.addEventListener('DOMContentLoaded', function() {
            // Login form submit
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    login();
                });
            }
            
            // Password field enter key
            const passwordField = document.getElementById('password');
            if (passwordField) {
                passwordField.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        login();
                    }
                });
            }
            
            // Initialize date fields
            const today = new Date().toISOString().split('T')[0];
            const dateFields = ['fromDate', 'toDate', 'permDate', 'attendanceDate'];
            
            dateFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.value = today;
                    field.min = '2024-01-01';
                    field.max = today;
                }
            });
            
            // Set timesheet today date
            const timesheetToday = document.getElementById('timesheetTodayDate');
            if (timesheetToday) {
                timesheetToday.textContent = today;
            }
            
            // Set current year/month for reports
            const now = new Date();
            const currentYear = now.getFullYear().toString();
            const currentMonth = (now.getMonth() + 1).toString().padStart(2, '0');
            
            const reportYear = document.getElementById('reportYear');
            const reportMonth = document.getElementById('reportMonth');
            
            if (reportYear) reportYear.value = currentYear;
            if (reportMonth) reportMonth.value = currentMonth;
            
            // Initialize timesheet form
            initializeTimesheetForm();
            
            // Close modals when clicking outside
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.style.display = 'none';
                    }
                });
            });
        });

        // Default accounts for testing:
        // 1. HR Manager: hr / hr123 (role: "hr" - SHOULD SEE HR PANEL AND ADMIN PANEL BUT CANNOT APPROVE/REJECT)
        // 2. Admin: admin / admin123 (role: "hr" - SHOULD SEE HR PANEL AND ADMIN PANEL)  
        // 3. Employee: employee / emp123 (role: "employee" - SHOULD NOT SEE HR PANEL OR ADMIN PANEL)
        // 4. Venkatesh: venkatesh / venkat123 (role: "employee" - Timesheet example user)
        // 5. Manager: manager / manager123 (role: "manager")
        // 6. Project Manager: projectmanager / pm123 (role: "pm" - SHOULD SEE HR PANEL AND ADMIN PANEL WITH ALL PRIVILEGES)
    </script>
</body>
</html>